<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>FUTBOL TECUALA - ESTAD√çSTICAS COMPLETAS</title>
    <style>
        :root { --primary: #0f172a; --accent: #3b82f6; --success: #10b981; --danger: #ef4444; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 0; }

        nav { background: var(--primary); padding: 10px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; position: sticky; top: 0; z-index: 1000; }
        .nav-link { background: #1e293b; color: white; border: 1px solid #334155; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; text-decoration: none; font-size: 13px; }
        .nav-link:hover { background: var(--accent); }
        .nav-link.active { background: var(--accent); border-color: white; }

        .container { max-width: 1000px; margin: 20px auto; padding: 0 20px; }

       .seccion {display: none; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
	}

	.seccion.visible { display: block !important;
	}
	
        h2 { margin-top: 0; color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .form-group { background: #f1f5f9; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .input-std { width: 100%; padding: 10px; margin: 5px 0 15px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #f1f5f9; padding: 12px; font-size: 11px; text-transform: uppercase; color: #64748b; border: 1px solid #eee; }
        td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; font-size: 14px; }

        .btn-main { background: var(--success); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; }
        
        .equipo-card { 
            background: white; border: 1px solid #eee; border-radius: 10px; padding: 15px; 
            text-align: center; cursor: pointer; transition: 0.2s; position: relative;
        }
        .equipo-card:hover { border-color: var(--accent); background: #f0f9ff; }
        .img-logo { width: 60px; height: 60px; object-fit: contain; margin-bottom: 10px; display: block; margin: 0 auto; }
        
        .img-tabla { width: 24px; height: 24px; object-fit: contain; vertical-align: middle; margin-right: 8px;border-radius: 4px; }

        .partido-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .stat-input-row { display: grid; grid-template-columns: 0.5fr 2fr 1fr 1fr 1fr 1.5fr; gap: 5px; background: #f9f9f9; padding: 10px; border-radius: 8px; margin-bottom: 5px; align-items: center; }
        
        .btn-del { background: var(--danger); color: white; border: none; padding: 5px 8px; border-radius: 4px; cursor: pointer; font-size: 10px; margin-left: 5px; }

        .backup-zone { display: flex; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ccc; }
        .btn-backup { flex: 1; padding: 10px; font-size: 12px; cursor: pointer; border-radius: 6px; border: 1px solid #ddd; font-weight: bold; }

    @media print { 
    nav, .no-print, button, .form-group, .seccion { 
        display: none !important; 
    } 

    /* La clase .print-active se la daremos por JS a la secci√≥n que queramos imprimir */
    .only-print, .seccion.print-active { 
        display: block !important; 
    } 

    .seccion { box-shadow: none !important; padding: 0 !important; }
    body { background: white; }
    table { border: 1px solid #000; width: 100%; border-collapse: collapse; margin-top: 10px; }
    th { background-color: #f1f5f9 !important; -webkit-print-color-adjust: exact; color: black; border: 1px solid #000; }
    td { border: 1px solid #ddd; }
}
/* Badge del Ranking (Ej: #1) */
.fc-rank-badge {
    background: #d4af37;
    color: #000;
    font-size: 11px;
    font-weight: 900;
    padding: 2px 6px;
    border-radius: 4px;
    margin: 4px 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

/* Efecto Brillo para el mejor de los dos */
.fc-glow {
    box-shadow: 0 0 25px rgba(212, 175, 55, 0.6);
    transform: scale(1.05);
    z-index: 20;
    transition: all 0.3s ease;
}

/* Ajuste del Ranking en la carta */
.fc-rating-side {
    position: absolute;
    top: 25px;
    left: 12px;
    z-index: 10;
    text-align: center;
}

.fc-overall {
    font-family: 'Arial Black', sans-serif;
    font-size: 34px;
    color: #eee;
    text-shadow: 2px 2px 0px #000;
}
.plantilla-grid {
    display: grid;
    /* Esto crea columnas autom√°ticas que no bajan de 180px */
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 25px;
    padding: 20px;
    justify-items: center; /* Centra las cartas si sobra espacio */
}

/* Estilo para cuando no hay jugadores (el mensaje de aviso) */
.plantilla-grid p {
    grid-column: 1 / -1;
    text-align: center;
    font-style: italic;
    color: #94a3b8;
}
/* --- CORRECCI√ìN INTEGRAL DE CARTA FC26 --- */

.fc-card-inner {
    background: #111;
    width: 100%;
    height: 100%;
    clip-path: polygon(0% 12%, 50% 0%, 100% 12%, 100% 88%, 50% 100%, 0% 88%);
    display: flex;
    flex-direction: column;
    overflow: hidden; /* Evita que la foto se salga */
}

/* 1. Zona Superior (Rating y Foto) */
.fc-card-top {
    display: flex;
    height: 55%; /* Limitamos la altura para dejar espacio abajo */
    position: relative;
    padding-top: 25px;
    z-index: 1;
}

.fc-rating-zone {
    width: 35%;
    display: flex;
    flex-direction: column;
    align-items: center;
    color: #f5e3a9;
    z-index: 5;
    padding-left: 10px;
}

.fc-overall { font-size: 24px; font-weight: 900; line-height: 1; }
.fc-pos { font-size: 9px; font-weight: bold; color: #fff; margin-top: 5px; }
.fc-pos-val { font-size: 11px; font-weight: bold; color: #fff; }

/* 2. Ajuste de la Foto (El problema principal) */
.fc-player-img {
    width: 100px;
    height: 100px;
    object-fit: cover;
    position: absolute;
    right: 5px;
    bottom: 0;
    /* Efecto de desvanecimiento inferior para que no tape los stats */
    mask-image: linear-gradient(to bottom, black 75%, transparent 100%);
    -webkit-mask-image: linear-gradient(to bottom, black 75%, transparent 100%);
}

/* 3. Zona Inferior (Nombre y Stats) */
.fc-card-bottom {
    background: rgba(255, 255, 255, 0.05);
    height: 45%;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 8px 5px 0 5px;
    z-index: 2;
}

.fc-name {
    font-size: 12px;
    font-weight: 800;
    color: #fff;
    text-align: center;
    width: 90%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    border-bottom: 1px solid rgba(245, 227, 169, 0.3);
    padding-bottom: 3px;
    margin-bottom: 5px;
}

/* 4. Grid de Estad√≠sticas (Alineaci√≥n perfecta) */
.fc-stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    width: 100%;
    padding: 0 10px;
}

.fc-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.fc-stat .label { 
    font-size: 7px; 
    color: #aaa; 
    font-weight: bold; 
    text-transform: uppercase;
}

.fc-stat .value { 
    font-size: 13px; 
    font-weight: 900; 
    color: #fff; 
}

.fc-divider { display: none; } /* Quitamos el divider manual si usamos el grid */
/* Contenedor Grid Ajustado */
.plantilla-grid {
    display: grid;
    /* Reducimos el m√≠nimo de 200px a 160px */
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 15px;
    padding: 15px;
}

/* La Carta Versi√≥n Peque√±a */
.simple-card {
    background: white;
    border-radius: 10px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    overflow: hidden;
    position: relative;
    transition: transform 0.2s;
    width: 160px; /* Tama√±o m√°s peque√±o */
}

.simple-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 12px rgba(0,0,0,0.1);
}

/* Imagen Ajustada */
.sc-img-container {
    width: 100%;
    height: 140px; /* Altura reducida */
    background: #f8fafc;
}

.sc-img-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Contenedor de info con Flexbox */
.sc-info {
    padding: 8px;
    text-align: center;
    display: flex;
    flex-direction: column;
    justify-content: flex-start; /* Empuja todo hacia arriba */
    gap: 6px; /* Espacio peque√±o y constante entre nombre y stats */
}

.sc-name {
    font-size: 12px;
    font-weight: 800;
    color: #1e293b;
    text-transform: uppercase;
    line-height: 1.1;
    
    /* Multil√≠nea din√°mica sin altura fija */
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    
    /* Esto evita que el nombre se separe de las stats */
    margin: 0; 
    padding: 0;
}

/* Reducimos un poco el margen del grid de stats para que suba m√°s */
.sc-stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 3px;
    background: #f1f5f9;
    border-radius: 4px;
    padding: 3px;
    margin-top: 2px; /* Espacio m√≠nimo con el nombre */
}

.sc-stat-item {
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    padding: 3px;
    font-size: 11px; /* N√∫meros m√°s peque√±os */
    font-weight: bold;
}

/* Iconos de Admin m√°s discretos */
.sc-admin-tools {
    position: absolute;
    top: 5px;
    right: 5px;
    display: flex;
    gap: 3px;
    z-index: 10;
}

.sc-admin-tools button {
    background: rgba(255, 255, 255, 0.85);
    border: none;
    border-radius: 4px;
    padding: 4px;
    font-size: 10px;
    cursor: pointer;
}
/* Clase especial para el MVP */
.card-mvp {
    border: 2px solid #ffd700 !important; /* Oro */
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.6) !important;
    position: relative;
}

/* Etiqueta de "MVP" sobre la foto */
.card-mvp::after {
    content: "‚≠ê MVP";
    position: absolute;
    top: 5px;
    left: 5px;
    background: #ffd700;
    color: #000;
    font-size: 10px;
    font-weight: 900;
    padding: 2px 6px;
    border-radius: 4px;
    z-index: 5;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* Efecto de brillo sutil para la carta estrella */
.card-mvp {
    animation: shine-gold 3s infinite;
}

@keyframes shine-gold {
    0% { filter: brightness(1); }
    50% { filter: brightness(1.1); }
    100% { filter: brightness(1); }
}
/* Contenedor del icono de Doble Amarilla */
.doble-tarjeta-container {
    display: inline-flex;
    position: relative;
    width: 24px;
    height: 18px;
    vertical-align: middle;
    margin-left: 5px;
}

/* Base de ambas tarjetas */
.card-mini {
    width: 12px;
    height: 16px;
    border-radius: 2px;
    position: absolute;
    border: 1px solid rgba(0,0,0,0.2);
}

/* Tarjeta Amarilla (abajo) */
.card-yellow {
    background-color: #ffeb3b;
    left: 0;
    top: 2px;
    z-index: 1;
    transform: rotate(-10deg); /* Un poco inclinada */
}

/* Tarjeta Roja (encimada) */
.card-red {
    background-color: #f44336;
    left: 6px;
    top: 0;
    z-index: 2;
    transform: rotate(5deg); /* Inclinada hacia el otro lado */
    box-shadow: -1px 1px 3px rgba(0,0,0,0.3);
}
.name-pj strong {
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

.item-goleador:hover {
    transform: scale(1.01);
    transition: transform 0.2s ease;
    border-color: #cbd5e1;
    background: #ffffff !important;
}
#tabla-posiciones thead {
    background: #1e293b;
    color: white;
}
#tabla-posiciones th {
    padding: 15px;
    text-transform: uppercase;
    font-size: 12px;
}
</style>

</head>
<body>
<div id="auth-panel" style="background:#1e293b; color:white; padding:10px; display:flex; justify-content:center; gap:15px; align-items:center; font-size:12px;">
    <span id="status-role">MODO: üë§ USUARIO (Solo Lectura)</span>
    <div id="auth-actions">
        <button onclick="loginAdmin()" id="btn-login" style="background:var(--accent); border:none; color:white; padding:5px 10px; border-radius:4px; cursor:pointer;">Acceso Admin</button>
    </div>
</div>

<nav>
    <button class="nav-link active" onclick="navegar('sec-inicio', this)">üè† INICIO</button>
    <button class="nav-link" onclick="navegar('sec-calendario', this)">üìÖ CALENDARIO</button>
    <button class="nav-link" onclick="navegar('sec-equipos', this)">üõ°Ô∏è EQUIPOS</button>
    <button class="nav-link" onclick="navegar('sec-partido', this)">‚öΩ PARTIDO</button>
    <button class="nav-link" onclick="navegar('sec-tabla', this)">üèÜ TABLA</button>
    <button class="nav-link" onclick="navegar('sec-playoffs', this)">üèÜ PLAYOFFS</button> 
    <button class="nav-link" onclick="navegar('sec-goleadores', this)">üéØ GOLES</button>
    <button class="nav-link" onclick="navegar('sec-disciplina', this)">üü® DISCIPLINA</button>
    <button class="nav-link" onclick="navegar('sec-buscador', this)">üîç BUSCAR</button>
    <button onclick="navegar('sec-comparador'); prepararComparador();" class="nav-link">‚öñÔ∏è COMPARAR</button>
    <button class="nav-link" onclick="navegar('sec-mi-calendario', this)">üîç MI CALENDARIO</button>
    <button class="nav-link" onclick="navegar('sec-ajustes', this)">‚öôÔ∏è AJUSTES</button>
</nav>

<div class="container">
    
<div id="sec-inicio" class="seccion visible">
    <div style="position: relative; width: 100%; height: 350px; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
        <img src="https://images.unsplash.com/photo-1574629810360-7efbbe195018?q=80&w=2000&auto=format&fit=crop" 
             style="width: 100%; height: 100%; object-fit: cover; filter: brightness(0.6);">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; width: 90%;">
            <h1 id="banner-titulo" style="color: white; font-size: clamp(2.5rem, 8vw, 4.5rem); font-weight: 900; margin: 0; text-transform: uppercase; letter-spacing: 4px; text-shadow: 2px 2px 10px rgba(0,0,0,0.8); font-style: italic;">
                LIGA PRO <span style="color: var(--accent);">ELITE</span>
            </h1>
            <div style="width: 120px; height: 6px; background: var(--accent); margin: 15px auto; border-radius: 3px;"></div>
            <p id="banner-temporada" style="color: white; font-size: 1.3rem; font-weight: bold; text-shadow: 1px 1px 5px rgba(0,0,0,0.5); letter-spacing: 1px;">
                ESTAD√çSTICAS OFICIALES 2026
            </p>
        </div>
    </div>

    <h2 style="text-align: center; margin-top: 30px; font-weight: 900; color: #1e293b;">üìä RESUMEN DE TEMPORADA</h2>
    <div id="render-resumen-inicio"></div>
</div>

	<div id="sec-calendario" class="seccion">
    <h2>Calendario de Juegos</h2>
    
    <div class="form-group no-print admin-only" style="display: none;">
        <label>N√∫mero de Vueltas:</label>
        <select id="vueltas" class="input-std">
            <option value="1">1 Vuelta</option>
            <option value="2">2 Vueltas</option>
        </select>
        <button onclick="generarCalendario()" class="btn-main" style="background:var(--primary)">
            GENERAR NUEVO CALENDARIO
        </button>
    </div>
    
    <div id="render-calendario"></div>
</div>

    <div id="sec-ajustes" class="seccion">
    <h2>‚öôÔ∏è Configuraci√≥n del Sistema</h2>
    
    <div class="form-group" style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
        <h3 style="margin-top: 0;">üèÜ Identidad del Torneo</h3>
        <p style="font-size: 13px; color: #64748b; margin-bottom: 15px;">Cambia los nombres que aparecen en el Banner de Inicio y en los Reportes PDF.</p>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
                <label style="display:block; font-size: 11px; font-weight: bold; color: #475569; margin-bottom: 5px;">NOMBRE DEL TORNEO:</label>
                <input type="text" id="cfg-nombre-torneo" placeholder="Ej: COPA CHAMPIONS" style="width:100%; padding:10px; border-radius:6px; border:1px solid #cbd5e1;">
            </div>
            <div>
                <label style="display:block; font-size: 11px; font-weight: bold; color: #475569; margin-bottom: 5px;">TEMPORADA / ESLOGAN:</label>
                <input type="text" id="cfg-nombre-temporada" placeholder="Ej: OFICIAL 2026" style="width:100%; padding:10px; border-radius:6px; border:1px solid #cbd5e1;">
            </div>
        </div>
        
        <button onclick="guardarConfiguracionGeneral()" class="btn-main" style="margin-top: 15px; background: #3b82f6; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold;">
            üíæ APLICAR CAMBIOS VISUALES
        </button>
    </div>

    <div class="form-group">
        <h3>üì¶ Gesti√≥n de Datos</h3>
        <p style="font-size: 13px; color: #64748b;">Descarga una copia de seguridad o restaura una anterior.</p>
        <div class="backup-zone" style="border-top: none; margin-top: 10px; padding-top: 0;">
            <button onclick="exportarDatos()" class="btn-backup" style="background: #e2e8f0; border: 1px solid #cbd5e1;">üì§ EXPORTAR RESPALDO</button>
            <button onclick="document.getElementById('import-file-main').click()" class="btn-backup" style="background: #e2e8f0; border: 1px solid #cbd5e1;">üì• IMPORTAR RESPALDO</button>
            <input type="file" id="import-file-main" style="display:none" accept=".json" onchange="importarDatos(this)">
        </div>
    </div>

    <div class="form-group admin-only" style="border: 2px solid #fee2e2; background: #fffafb; padding: 20px;">
        <h3 style="color: var(--danger); margin-top: 0;">‚ö†Ô∏è Zona de Peligro</h3>
        <p style="font-size: 13px; color: #64748b; margin-bottom: 15px;">
            Esta acci√≥n es irreversible. Se borrar√°n los resultados y estad√≠sticas, manteniendo solo la estructura de equipos si as√≠ lo deseas.
        </p>
        
        <button id="btn-reinicio-global" 
            onclick="reiniciarTodo()" 
            class="btn-main" 
            style="background:var(--danger); color:white; border:none; padding:12px; border-radius:6px; cursor:pointer; width: 100%; font-weight: bold;">
            ‚ôªÔ∏è REINICIAR TEMPORADA COMPLETA
        </button>
    </div>
</div>

    <div id="sec-equipos" class="seccion">
        <h2>üõ°Ô∏è Gesti√≥n de Equipos</h2>
        
       <div id="form-registro-equipo" class="form-group no-print admin-only">
    <h3 id="titulo-form-equipo">Registrar Nuevo Equipo</h3>
    <input type="hidden" id="edit-eq-id" value="-1">
    <input type="text" id="eq-nombre" placeholder="Nombre del Equipo" class="input-std">
    
    <label style="font-size: 11px; font-weight: bold;">LOGO DEL EQUIPO:</label>
    <input type="file" id="eq-logo-file" accept="image/*" class="input-std" onchange="procesarLogoEquipo(event)">
    
    <div style="display: flex; gap: 10px;">
        <button onclick="guardarEquipo()" class="btn-main" style="flex: 2;">GUARDAR EQUIPO</button>
        <button onclick="cancelarEdicionEquipo()" class="btn-main" style="background: var(--danger); flex: 1; display: none;" id="btn-cancelar-eq">X</button>
    </div>
</div>

        <div id="grid-equipos" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:15px; margin-top: 20px;"></div>

        <div id="panel-plantilla" style="display:none; margin-top:30px; border-top: 3px solid var(--accent); padding-top: 20px;">
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 id="tit-equipo" style="margin:0; color: var(--primary); font-weight: 900; text-transform: uppercase; letter-spacing: 1px;"></h3>
        <button onclick="document.getElementById('panel-plantilla').style.display='none'" 
                style="background:#f87171; color:white; border:none; padding:5px 15px; border-radius:5px; cursor:pointer; font-weight:bold;">
            CERRAR PLANTILLA √ó
        </button>
    </div>
    
    <div class="form-group editor-only" style="background: #f8fafc; border: 2px solid var(--accent); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
        <h4 style="margin-top: 0; color: var(--primary);">Ficha de Jugador</h4>
        
        <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
            <div style="text-align: center; min-width: 120px;">
                <div style="width: 100px; height: 100px; border: 2px dashed #cbd5e1; border-radius: 15px; display: flex; align-items: center; justify-content: center; overflow: hidden; background: white; margin-bottom: 8px;">
                    <img id="previsualizar-foto" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                    <span id="placeholder-foto" style="font-size: 24px; color: #94a3b8;">üë§</span>
                </div>
                <label for="foto-archivo" style="background: var(--primary); color: white; padding: 5px 10px; border-radius: 5px; font-size: 11px; cursor: pointer; display: block;">
                    SUBIR FOTO
                </label>
                <input type="file" id="foto-archivo" accept="image/*" style="display: none;" onchange="procesarFoto(event)">
            </div>

            <div style="flex: 1; display: flex; flex-direction: column; gap: 10px;">
                <input type="hidden" id="edit-pj-id" value="-1">
                <input type="text" id="pj-nombre" placeholder="Nombre del Jugador" class="input-std" style="margin:0;">
                <input type="text" id="pj-curp" placeholder="ID/DNI/CURP" class="input-std" style="margin:0;">
                
                <div style="display: flex; gap: 10px;">
                    <button onclick="guardarJugador()" class="btn-main" style="background: var(--success); flex: 2;">GUARDAR / FICHAR</button>
                    <button onclick="limpiarFormularioJugador()" class="btn-main" style="background: var(--danger); flex: 1;">X</button>
                </div>
            </div>
        </div>
    </div>

    <div id="body-plantilla" class="plantilla-grid">
        </div>

</div>
    </div>
    <div id="sec-partido" class="seccion"><div id="area-carga"></div></div>
    <div id="sec-tabla" class="seccion">
    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; margin-bottom: 10px; padding-bottom: 10px;">
        <h2 style="margin:0; border:none;">Tabla de Posiciones</h2>
        <button onclick="imprimirTabla()" class="btn-main no-print" style="width: auto; padding: 8px 20px; background: #f59e0b;">
            üñ®Ô∏è EXPORTAR TABLA PDF
        </button>
    </div>
    <table>
        <thead>
            <tr>
                <th>Pos</th>
                <th style="text-align:left">Equipo</th>
                <th>PJ</th><th>G</th><th>E</th><th>P</th><th>GF</th><th>GC</th><th>DG</th><th>PTS</th>
            </tr>
        </thead>
        <tbody id="body-tabla"></tbody>
    </table>
</div>
<div id="sec-goleadores" class="seccion">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin:0;">Estad√≠sticas de Goleo</h2>
        <button onclick="prepararImpresionGoleadores()" class="btn-main no-print" style="width:auto; background:#f59e0b;">
            üñ®Ô∏è PDF TOP 10
        </button>
    </div>

    <div id="diseno-goleadores-pro"></div>
</div>
        <div id="sec-disciplina" class="seccion"><h2>Disciplina</h2><div class="form-group no-print"><select id="orden-disc" onchange="renderTodo()" class="input-std" style="width:200px"><option value="roja">Ordenar por Rojas</option><option value="ama">Ordenar por Amarillas</option></select></div><table><thead><tr><th style="text-align:left">Jugador</th><th>Equipo</th><th>üü®</th><th>üü•</th></tr></thead><tbody id="body-disciplina"></tbody></table></div>

<div id="sec-buscador" class="seccion">
    <h2>Buscador de Jugadores</h2>
    <div class="form-group no-print">
        <input type="text" id="input-busqueda" oninput="buscarJugador()" placeholder="Escribe el nombre del jugador..." class="input-std" style="font-size: 18px; border: 2px solid var(--accent);">
    </div>
       <div id="resultados-busqueda">
        <p style="text-align:center; color:#64748b;">Escribe un nombre para comenzar la b√∫squeda...</p>
    </div>
</div>

<div id="sec-playoffs" class="seccion">
    <div style="background: linear-gradient(135deg, #1e293b 0%, #3b82f6 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 25px; text-align: center; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);">
        <h2 style="color: white; border: none; margin: 0; font-size: 28px; text-transform: uppercase; letter-spacing: 2px;">üèÜ Fase de Eliminatorias</h2>
        <p style="opacity: 0.9; margin-top: 10px;">Define el camino hacia el campeonato</p>
    </div>

    <div class="form-group no-print editor-only" style="background: white; border: 1px solid #e2e8f0; padding: 20px; border-radius: 12px; display: flex; gap: 15px; align-items: center; justify-content: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
        <div style="display: flex; flex-direction: column; gap: 5px;">
            <label style="font-weight: bold; color: #64748b; font-size: 12px;">SELECCIONAR FORMATO:</label>
            <select id="p-formato" class="input-std" style="margin: 0; min-width: 200px;">
                <option value="2">Gran Final (Top 2)</option>
                <option value="4">Semifinales (Top 4)</option>
                <option value="8">Cuartos de Final (Top 8)</option>
            </select>
        </div>
        <button onclick="generarCrucesPlayoffs()" class="btn-main" style="background: #3b82f6; width: auto; padding: 15px 30px; margin-top: 18px; transition: all 0.3s ease;">
            ‚ö° GENERAR CRUCES
        </button>
    </div>

    <div id="render-playoffs" style="margin-top: 30px;">
        </div>
</div>
<div id="sec-disciplina" class="seccion" style="display:none;">
    </div>
<div id="sec-comparador" class="seccion" style="display:none; padding:10px; max-width: 900px; margin: 0 auto;">
    
    <div style="text-align:center; margin-bottom:15px;">
        <h1 style="margin:0; font-size: 30px; font-weight: 900; color: #0f172a; letter-spacing: -1px; text-transform: uppercase; font-style: italic;">
            CARA <span style="color: #3b82f6;">A</span> CARA
        </h1>
        <div style="width: 40px; height: 3px; background: #3b82f6; margin: 5px auto; border-radius: 2px;"></div>
    </div>
    
    <div style="max-width: 350px; margin: 0 auto 15px auto; position: relative;">
        <input type="text" id="main-search" placeholder="üîç Buscar jugador..." 
               oninput="filtrarBusquedaUnica()" 
               style="width:100%; padding:12px; border:2px solid #e2e8f0; border-radius:12px; font-size:14px; text-align:center; outline:none; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
        
        <div id="main-results" style="position:absolute; top:105%; left:0; right:0; background:white; z-index:1000; box-shadow:0 10px 20px rgba(0,0,0,0.1); border-radius:10px; max-height:200px; overflow-y:auto; display:none; border:1px solid #e2e8f0;"></div>
    </div>

    <div style="text-align: center; margin-bottom: 10px;">
        <button onclick="limpiarDuelo()" style="background:none; border:none; color:#94a3b8; cursor:pointer; font-size:11px; text-decoration:underline;">
            üîÑ Limpiar
        </button>
    </div>

    <input type="hidden" id="select-j1" value="">
    <input type="hidden" id="select-j2" value="">

    <div id="render-comparativa"></div>
</div>

<style>
    /* Animaci√≥n de aparici√≥n para las cartas */
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(30px) scale(0.9); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .animar-entrada { animation: fadeInUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
/* Por defecto todo oculto */
/* 1. Las secciones se controlan por la clase .visible, NO por el rol */
.seccion { 
    display: none; 
}
.seccion.visible { 
    display: block !important; 
}

/* 2. Los elementos internos s√≠ se controlan por rol */
.admin-only, .editor-only { 
    display: none !important; 
}

/* Mostrar seg√∫n el rol activo en el body */
body.role-admin .admin-only,
body.role-admin .editor-only { 
    display: block !important; 
}

body.role-editor .editor-only { 
    display: block !important; 
}
.card-resumen {
    background: white;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    border-left: 4px solid #3b82f6;
}
.card-resumen small {
    display: block;
    font-weight: 800;
    font-size: 10px;
    color: #64748b;
    margin-bottom: 5px;
}
.card-resumen .val {
    font-size: 16px;
    font-weight: 900;
    color: #1e293b;
    text-transform: uppercase;
}
.card-resumen p {
    margin: 0;
    font-size: 13px;
    color: #64748b;
}
.card-resumen {
    background: #ffffff;
    padding: 15px;
    border-radius: 16px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    transition: transform 0.2s;
}

.card-resumen:hover {
    transform: translateY(-5px);
}

.card-resumen small {
    display: block;
    font-weight: 900;
    font-size: 11px;
    color: #94a3b8;
    letter-spacing: 0.5px;
    text-transform: uppercase;
}

.card-resumen .val {
    font-size: 15px;
    font-weight: 900;
    color: #1e293b;
    line-height: 1.2;
}

.card-resumen p {
    margin: 0;
    color: #64748b;
}
.card-resumen {
    min-height: 110px; /* Para mantener uniformidad */
    display: flex;
    flex-direction: column;
    justify-content: center;
}
/* Animaci√≥n de brillo para el MVP */
@keyframes brilloOro {
    0% { box-shadow: 0 0 5px #ffd700, 0 0 10px #ffd700; }
    50% { box-shadow: 0 0 20px #ffcc00, 0 0 30px #ffae00; }
    100% { box-shadow: 0 0 5px #ffd700, 0 0 10px #ffd700; }
}

.card-mvp {
    position: relative;
    background: linear-gradient(145deg, #ffffff, #fffdf0) !important;
    border: 2px solid #ffd700 !important;
    animation: brilloOro 3s infinite;
    overflow: hidden;
}

/* Destello de luz pasando por la tarjeta */
.card-mvp::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,215,0,0.1), transparent);
    transform: rotate(45deg);
    animation: brilloPasante 4s infinite;
}

@keyframes brilloPasante {
    0% { transform: translateX(-100%) rotate(45deg); }
    100% { transform: translateX(100%) rotate(45deg); }
}
.card-resumen:active {
    transform: scale(0.95);
    transition: transform 0.1s;
}
/* DISE√ëO PRO GOLEADORES */
.contenedor-goleadores-pro {
    display: grid;
    grid-template-columns: 1fr 1.2fr;
    gap: 20px;
    background: #f0f2f5;
    padding: 20px;
    border-radius: 20px;
    font-family: 'Segoe UI', sans-serif;
}

.mvp-card {
    background: white;
    border-radius: 20px;
    padding: 30px;
    text-align: center;
    position: relative;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.mvp-photo-wrapper {
    position: relative;
    width: 220px;
    height: 220px;
    margin: 0 auto 20px;
}
.mvp-team-logo {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 60px; /* Tama√±o controlado */
    height: 60px;
    object-fit: contain;
    background: white;
    padding: 5px;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.mvp-photo {
    width: 200px;
    height: 200px;
    object-fit: cover;
    border-radius: 50%;
    border: 5px solid #4caf50;
}

.mvp-number {
    position: absolute;
    bottom: 10px;
    right: 10px;
    background: #4caf50;
    color: white;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: 900;
    border: 4px solid white;
}

.mvp-info h2 { font-size: 28px; margin: 0; color: #1a1a1a; text-transform: uppercase; }

.mvp-stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    margin-top: 20px;
    border-top: 1px solid #eee;
    padding-top: 15px;
}

.stat-item strong { font-size: 24px; display: block; }
.stat-item small { color: #888; font-size: 10px; }

/* LISTADO DERECHA */
.lista-goleadores { display: flex; flex-direction: column; gap: 8px; }

.item-goleador {
    background: #1e293b;
    color: white;
    display: flex;
    align-items: center;
    padding: 10px 15px;
    border-radius: 12px;
    transition: 0.3s;
}

.item-goleador:hover { transform: scale(1.02); background: #334155; }

.rank { width: 30px; font-weight: 900; opacity: 0.5; }
.img-pj { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 15px; }
.name-pj { flex: 1; display: flex; flex-direction: column; }
.name-pj span { font-size: 11px; opacity: 0.7; }
.img-eq { width: 25px; height: 25px; object-fit: contain; margin: 0 15px; }
.goles-pj { font-size: 22px; font-weight: 900; color: #4caf50; width: 40px; text-align: right; }

/* AJUSTE PARA M√ìVILES */
@media (max-width: 800px) {
    .contenedor-goleadores-pro { grid-template-columns: 1fr; }
}
/* Estilo de Tarjetas de Disciplina */
.card-ui {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 32px;
    border-radius: 4px;
    font-weight: bold;
    color: rgba(0,0,0,0.6);
    font-size: 14px;
    box-shadow: 1px 2px 4px rgba(0,0,0,0.2);
}

.card-ui.ama {
    background: #facc15; /* Amarillo intenso */
    border: 1px solid #eab308;
}

.card-ui.roja {
    background: #ef4444; /* Rojo intenso */
    border: 1px solid #dc2626;
    color: white;
}
.fc-comparison-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    padding: 20px;
    background: radial-gradient(circle, #1e293b 0%, #0f172a 100%);
    border-radius: 20px;
    color: white;
}

/* DISE√ëO DE LA CARTA */
.fc-card {
    width: 200px;
    height: 280px;
    background: linear-gradient(135deg, #d4af37 0%, #f9e27d 50%, #b8860b 100%);
    clip-path: polygon(10% 0, 90% 0, 100% 10%, 100% 85%, 50% 100%, 0 85%, 0 10%);
    padding: 5px;
    position: relative;
}

.fc-card-inner {
    background: #111;
    width: 100%;
    height: 100%;
    clip-path: polygon(10% 0, 90% 0, 100% 10%, 100% 85%, 50% 100%, 0 85%, 0 10%);
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    overflow: hidden;
}

.fc-team-badge {
    position: absolute;
    top: 35px;
    left: 15px;
    width: 35px; /* LOGO PEQUE√ëO Y CONTROLADO */
    height: 35px;
    object-fit: contain;
    z-index: 5;
}

.fc-photo-container {
    width: 100%;
    height: 65%;
    margin-top: 10px;
}

.fc-player-photo {
    width: 100%;
    height: 100%;
    object-fit: cover;
    filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5));
}

.fc-info {
    text-align: center;
    padding: 5px;
    background: rgba(0,0,0,0.8);
    width: 100%;
}

.fc-name { font-weight: 900; font-size: 16px; text-transform: uppercase; color: #d4af37; }
.fc-team-name { font-size: 10px; opacity: 0.8; }

/* PANEL CENTRAL */
.fc-stats-panel { flex: 1; padding: 0 20px; }
.vs-badge { 
    background: #d4af37; color: black; font-weight: 900; width: 50px; 
    height: 50px; border-radius: 50%; display: flex; align-items: center; 
    justify-content: center; margin: 0 auto 20px; border: 3px solid #111;
}

.fc-stat-row { margin-bottom: 15px; }
.fc-stat-labels { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 5px; }
.fc-stat-name { font-size: 12px; color: #94a3b8; }
.fc-bar-bg { height: 6px; background: #334155; display: flex; border-radius: 3px; overflow: hidden; }
.fc-bar-fill.left { background: #3b82f6; border-right: 1px solid white; }
.fc-bar-fill.right { background: #ef4444; }
.winner-text { color: #d4af37; font-size: 1.2em; }
/* Ajustes para el estilo de carta con Rating */
.fc-rating-side {
    position: absolute;
    top: 25px;
    left: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 10;
    color: #d4af37;
}

.fc-overall {
    font-size: 32px;
    font-weight: 900;
    line-height: 1;
}

.fc-pos {
    font-size: 10px;
    font-weight: bold;
    margin-bottom: 5px;
}

.fc-team-badge-small {
    width: 25px; /* LOGO MUY PEQUE√ëO Y ELEGANTE */
    height: 25px;
    object-fit: contain;
}

.fc-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: rgba(255,255,255,0.2);
    font-weight: bold;
    font-size: 12px;
    text-align: center;
    padding: 20px;
}

.empty-theme {
    background: rgba(255,255,255,0.05) !important;
    border: 2px dashed rgba(255,255,255,0.1);
    clip-path: none !important; /* Quita el corte de carta para el slot vac√≠o */
}
/* Estilo para el n√∫mero de Ranking Grande */
.fc-overall {
    font-family: 'Arial Black', sans-serif;
    font-size: 42px; /* M√°s grande para que destaque */
    font-weight: 900;
    color: #f1f5f9;
    line-height: 0.8;
    text-shadow: 3px 3px 0px #000;
    margin-bottom: 2px;
}

.fc-pos-label {
    font-size: 10px;
    font-weight: 900;
    color: #d4af37;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
}

/* El logo del equipo ahora va justo debajo del texto RANK */
.fc-team-badge-small {
    width: 28px;
    height: 28px;
    object-fit: contain;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
}

.fc-rating-side {
    position: absolute;
    top: 20px;
    left: 12px;
    z-index: 10;
    display: flex;
    flex-direction: column;
    align-items: center;
}
.fc-rating-side {
    position: absolute;
    top: 20px;
    left: 12px;
    z-index: 10;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.fc-overall {
    font-family: 'Arial Black', sans-serif;
    font-size: 46px; /* Tama√±o impactante */
    font-weight: 900;
    color: #f8fafc;
    line-height: 0.8;
    text-shadow: 3px 3px 0px #000;
}

.fc-pos-label {
    font-size: 10px;
    font-weight: 800;
    color: #d4af37;
    margin: 4px 0;
    letter-spacing: 1px;
}

.fc-team-badge-small {
    width: 30px;
    height: 30px;
    object-fit: contain;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
}
.fc-delete-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    z-index: 50;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    transition: transform 0.2s;
}

.fc-delete-btn:hover {
    transform: scale(1.2);
    background: #dc2626;
}
#sec-disciplina table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 8px;
}

#sec-disciplina tr {
    background: #f8fafc;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

#sec-disciplina td {
    padding: 12px;
    text-align: center;
}

#sec-disciplina td:first-child {
    border-radius: 10px 0 0 10px;
}

#sec-disciplina td:last-child {
    border-radius: 0 10px 10px 0;
}
</style>

<div id="sec-mi-calendario" class="seccion">
        <h2 style="text-align: center;">üîç Partidos de la Temporada</h2>
        
        <div class="no-print" style="margin-bottom: 20px; display: flex; gap: 10px; background: #f1f5f9; padding: 15px; border-radius: 12px;">
            <input type="text" id="busqueda-usuario" 
                   placeholder="Escribe el nombre de tu equipo..." 
                   style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 16px;"
                   onkeyup="renderMiCalendario()">
            
            <button onclick="window.print()" class="btn-publico-pdf" 
                    style="background: #ef4444; color: white; border: none; padding: 0 20px; border-radius: 8px; font-weight: bold; cursor: pointer;">
                PDF üìÑ
            </button>
        </div>

        <div id="render-mi-calendario"></div>
    </div> 
    </div>

<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

<script>
  // 2. Tu configuraci√≥n (la que me pasaste)
  const firebaseConfig = {
    apiKey: "AIzaSyArH_E5ieh0293mDKrNrW5kOnzYK1-9oU4",
    authDomain: "futboltecuala-7dc52.firebaseapp.com",
    databaseURL: "https://futboltecuala-7dc52-default-rtdb.firebaseio.com",
    projectId: "futboltecuala-7dc52",
    storageBucket: "futboltecuala-7dc52.firebasestorage.app",
    messagingSenderId: "1027361474936",
    appId: "1:1027361474936:web:c29d598512d210595da08d"
  };

  // 3. Inicializamos Firebase para que est√© disponible en todo tu c√≥digo
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
  console.log("üî• Firebase conectado a Futbol Tecuala");
</script>
<script>
let db = JSON.parse(localStorage.getItem('LIGA_PRO_FINAL')) || { 
    equipos: [], 
    jugadores: [], 
    calendario: [], 
    playoffs: {},
    nombreTemporada: "ESTAD√çSTICAS OFICIALES 2026",
    nombreTorneoActual: "COPA CHAMPIONS 2026" // Valor por defecto inicial
};

// Ahora la variable global toma el valor de la db (lo que se guard√≥) 
// o el valor por defecto si la db es nueva.
let nombreTorneoActual = db.nombreTorneoActual || "COPA CHAMPIONS 2026";

let equipoActual = "";
let proximoSlot = 1;
let fotoBase64Temp = ""; 
let modoAdmin = false; 

const persist = () => {
    // 1. Sigue guardando en la memoria del navegador (local)
    localStorage.setItem('LIGA_PRO_FINAL', JSON.stringify(db));

    // 2. NUEVO: Manda los datos a tu base de datos en Firebase
    database.ref('liga_datos').set(db)
        .then(() => console.log("‚òÅÔ∏è Sincronizado en la nube"))
        .catch(err => console.error("‚ùå Error de Firebase:", err));
};

function procesarLogoEquipo(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            fotoBase64Temp = e.target.result; // Llenamos la variable global
            console.log("Imagen cargada en memoria");
        };
        reader.readAsDataURL(file);
    }
}

let rolActual = "usuario"; // "usuario", "editor", "admin"

function loginAdmin() {
    const input = prompt("Internal Access Code");
    if (!input) return;

    // Convertimos lo que el usuario escribi√≥ a Base64
    const hashedInput = btoa(input);

    // Definimos las llaves ocultas
    const keyEditor = "Y2FyZ2E5ODc="; 
    const keyAdmin = "ZGlvczExOTA=";

    if (hashedInput === keyAdmin) {
        rolActual = 'admin';
        modoAdmin = true;
        document.body.classList.add('role-admin');
        document.body.classList.remove('role-editor');
        alert("Acceso total concedido (ADMIN).");
    } 
    else if (hashedInput === keyEditor) {
        rolActual = 'editor';
        modoAdmin = false; // El editor no es admin total, pero puede editar
        document.body.classList.add('role-editor');
        document.body.classList.remove('role-admin');
        alert("Acceso de edici√≥n concedido (EDITOR).");
    } 
    else {
        alert("C√≥digo de sistema no reconocido.");
        return;
    }

    // Actualizamos la interfaz para mostrar/ocultar botones
    aplicarRestricciones();
    renderTodo();
}

function actualizarInterfazAdmin() {
    // REGLA DE ORO: No toques .style.display manualmente aqu√≠.
    // El CSS ocultar√° el form-registro-equipo autom√°ticamente
    // porque el Editor NO tiene la clase .role-admin en el body.
    
    renderEquipos(); 
}
function aplicarRestricciones() {
    const status = document.getElementById('status-role');
    const btnLogin = document.getElementById('btn-login');
    const body = document.body;

    body.classList.remove('role-admin', 'role-editor');

    if (rolActual === 'admin' || rolActual === 'editor') {
        body.classList.add(rolActual === 'admin' ? 'role-admin' : 'role-editor');
        if (status) status.innerText = rolActual === 'admin' ? "MODO: üõ°Ô∏è ADMINISTRADOR" : "MODO: üìù EDITOR";
        
        if (btnLogin) {
            btnLogin.innerText = "Cerrar Sesi√≥n";
            btnLogin.onclick = logout; // <-- CAMBIO CLAVE: Ahora el bot√≥n cierra sesi√≥n
            btnLogin.style.background = "var(--danger)"; // Opcional: ponerlo rojo
        }
    } 
    else {
        if (status) status.innerText = "MODO: üë§ USUARIO (Solo Lectura)";
        if (btnLogin) {
            btnLogin.innerText = "Acceso Admin";
            btnLogin.onclick = loginAdmin; // <-- CAMBIO CLAVE: Vuelve a ser para loguearse
            btnLogin.style.background = "var(--accent)";
        }
    }

    // 3. Control de botones de navegaci√≥n (Ajustes y Calendario Admin)
    const botonesNav = document.querySelectorAll('.nav-link');
    
    botonesNav.forEach(btn => {
        const texto = btn.innerText.toUpperCase();
        
        // El bot√≥n AJUSTES solo para ADMIN
        if (texto.includes('AJUSTES')) {
            btn.style.display = (rolActual === 'admin') ? "inline-block" : "none";
        }
    });

    // 4. Asegurar que el panel de generaci√≥n de calendario solo sea para ADMIN
    const panelGenerador = document.querySelector('#sec-calendario .admin-only');
    if (panelGenerador) {
        panelGenerador.style.display = (rolActual === 'admin') ? "block" : "none";
    }
}
    // --- FUNCIONES DE RESPALDO ---
   // --- RESPALDOS ---
function exportarDatos() {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "respaldo_liga.json");
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
}

function importarDatos(input) {
    const reader = new FileReader();
    reader.onload = function(e) {
        db = JSON.parse(e.target.result);
        persist();
        location.reload();
    };
    reader.readAsText(input.files[0]);
}

   function navegar(idSeccion, boton) {
    // 1. Gesti√≥n de visibilidad (Ocultar todas, mostrar una)
    document.querySelectorAll('.seccion').forEach(s => s.classList.remove('visible'));
    const seccionActiva = document.getElementById(idSeccion);
    if(seccionActiva) seccionActiva.classList.add('visible');

    // 2. Gesti√≥n de Botones (Clase Active)
    document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
    if(boton) {
        boton.classList.add('active');
    } else {
        const btnNav = Array.from(document.querySelectorAll('.nav-link'))
                            .find(b => b.getAttribute('onclick')?.includes(idSeccion));
        if(btnNav) btnNav.classList.add('active');
    }

    // --- RENDERIZADO BAJO DEMANDA ---
    switch(idSeccion) {
        case 'sec-inicio':
            actualizarBanner(); 
            renderResumenInicio(); 
            renderTodo(); 
            break;
        
        // --- NUEVO CASO AGREGADO AQU√ç ---
        case 'sec-ajustes':
            // Rellenamos los inputs con los valores actuales al entrar
            const inputTorneo = document.getElementById('cfg-nombre-torneo');
            const inputTemp = document.getElementById('cfg-nombre-temporada');
            if(inputTorneo) inputTorneo.value = nombreTorneoActual;
            if(inputTemp) inputTemp.value = db.nombreTemporada;
            break;
        // --------------------------------

        case 'sec-equipos':
            renderEquipos(); 
            if (equipoActual !== null) verPlantilla(equipoActual);
            break;
        case 'sec-calendario':
            renderCalendario();
            break;
        case 'sec-buscador':
            buscarJugador();
            break;
        case 'sec-mi-calendario':
            renderMiCalendario();
            break;
        case 'sec-goleadores':
            renderGoleadores();
            break;
        case 'sec-tabla':
            renderTabla();
            break;
        case 'sec-playoffs':
            break;
        default:
            renderTodo();
    }

    // 3. Aplicar seguridad (Ocultar botones de Admin si es Usuario)
    aplicarRestricciones(); 
}
function guardarEquipo() {
    if (rolActual !== 'admin') {
        return alert("‚õî Permiso insuficiente.");
    }

    const nombre = document.getElementById('eq-nombre').value.trim().toUpperCase();
    const idEditando = document.getElementById('edit-eq-id').value;
    
    if (!nombre) return alert("Ingresa el nombre del equipo");

    const existe = db.equipos.find(e => e.nombre === nombre);
    
    if (idEditando === "-1") {
        if (existe) {
            return alert("‚ö†Ô∏è Error: Ya existe un equipo llamado " + nombre);
        }

        // NUEVO EQUIPO
        db.equipos.push({
            id: Date.now(),
            nombre: nombre,
            logo: fotoBase64Temp || "", 
            pj:0, g:0, e:0, p:0, gf:0, gc:0, pts:0 
        });

        // --- LINEAS CLAVE PARA EL PRIMER JUGADOR ---
        equipoActual = nombre; // Definimos que este es el equipo activo ahora
        document.getElementById('tit-equipo').innerText = nombre; // Actualizamos el t√≠tulo visualmente
        // -------------------------------------------

    } else {
        const idx = parseInt(idEditando);
        if (existe && db.equipos[idx].nombre !== nombre) {
            return alert("‚ö†Ô∏è Error: No puedes usar ese nombre porque ya pertenece a otro equipo.");
        }

        let antiguoNombre = db.equipos[idx].nombre;
        db.equipos[idx].nombre = nombre;

        if (fotoBase64Temp) {
            db.equipos[idx].logo = fotoBase64Temp;
        }

        if (antiguoNombre !== nombre) {
            actualizarVinculosEquipo(antiguoNombre, nombre);
        }
    }

    persist(); 
    fotoBase64Temp = ""; 
    document.getElementById('eq-logo-file').value = ""; 
    
    cancelarEdicionEquipo(); 
    renderTodo();

    // OPCIONAL: Abrir la plantilla del equipo reci√©n creado autom√°ticamente
    // verPlantilla(nombre); 

    alert("‚úÖ Equipo guardado correctamente. Ya puedes a√±adir jugadores.");
}
function actualizarVinculosEquipo(viejo, nuevo) {
    // Normalizamos para comparar sin errores de espacios o may√∫sculas
    const v = viejo.trim().toUpperCase();
    const n = nuevo.trim().toUpperCase();

    // 1. Actualizar Jugadores
    db.jugadores.forEach(j => {
        if (j.equipo.trim().toUpperCase() === v) {
            j.equipo = n;
        }
    });

    // 2. Actualizar Calendario (Partidos e Incidencias)
    db.calendario.forEach(semana => {
        semana.partidos.forEach(p => {
            // Local y Visitante
            if (p.l.trim().toUpperCase() === v) p.l = n;
            if (p.v.trim().toUpperCase() === v) p.v = n;
            
            // Incidencias
            if (p.inc && Array.isArray(p.inc)) {
                p.inc.forEach(incidencia => {
                    if (incidencia.equipo && incidencia.equipo.trim().toUpperCase() === v) incidencia.equipo = n;
                    if (incidencia.e && incidencia.e.trim().toUpperCase() === v) incidencia.e = n;
                });
            }
        });
    });

    // 3. Actualizar variable global y t√≠tulo en pantalla si la plantilla est√° abierta
    if (typeof equipoActual !== 'undefined' && equipoActual.trim().toUpperCase() === v) {
        equipoActual = n;
        const tit = document.getElementById('tit-equipo');
        if (tit) tit.innerText = n; // Actualiza el t√≠tulo visualmente si est√° abierto
    }

    persist(); 
    console.log(`‚úÖ Integridad total: ${v} ahora es ${n}`);
}
function borrarEquipo(index) {
    // 1. Verificaci√≥n de seguridad (Admin)
    if (typeof rolActual !== 'undefined' && rolActual !== "admin") {
        return alert("‚ö†Ô∏è Solo el Administrador puede borrar equipos.");
    }

    const equipo = db.equipos[index];
    if (!equipo) return;

    // 2. Comprobar si el equipo tiene jugadores (Integridad de datos)
    const tieneJugadores = db.jugadores.some(j => j.equipo === equipo.nombre);
    if (tieneJugadores) {
        alert(`No puedes borrar "${equipo.nombre}" porque tiene jugadores asignados. \n\nElimina primero a los jugadores de la plantilla.`);
        return;
    }

    // 3. Confirmaci√≥n y ejecuci√≥n
    if (confirm(`¬øEst√°s seguro de que deseas eliminar permanentemente al equipo: ${equipo.nombre}?`)) {
        
        db.equipos.splice(index, 1); // Elimina el equipo del array

        persist(); // Guarda los cambios en LocalStorage
        renderEquipos(); // Refresca la cuadr√≠cula de equipos
        
        // Si tienes la funci√≥n renderTodo (que actualiza la tabla), ll√°mala
        if (typeof renderTodo === 'function') renderTodo(); 
        
        alert("Equipo eliminado con √©xito.");
    }
}

function editarEq(i) {
    // Solo el rol admin puede cargar el formulario de edici√≥n
    if (rolActual !== 'admin') {
        return alert("‚õî Acceso denegado. Solo administradores pueden modificar equipos.");
    }
    document.getElementById('eq-nombre').value = db.equipos[i].nombre;
    document.getElementById('edit-eq-id').value = i;
    window.scrollTo({top: 0, behavior: 'smooth'});
}

function verPlantilla(referencia) {
    if (typeof limpiarFormularioJugador === 'function') limpiarFormularioJugador();

    let nombreEquipo;
    if (typeof referencia === 'number') {
        nombreEquipo = db.equipos[referencia].nombre;
    } else {
        nombreEquipo = referencia;
    }

    // --- NORMALIZACI√ìN CR√çTICA ---
    // Forzamos may√∫sculas y quitamos espacios para que la comparaci√≥n sea exacta
    nombreEquipo = nombreEquipo.trim().toUpperCase();
    equipoActual = nombreEquipo; 

    // Filtramos ignorando diferencias de escritura
    const plantilla = db.jugadores.filter(j => 
        (j.equipo || "").trim().toUpperCase() === nombreEquipo
    );
    
    const contenedor = document.getElementById('body-plantilla');
    
    // Actualizamos el t√≠tulo visualmente
    document.getElementById('tit-equipo').innerText = nombreEquipo;
    document.getElementById('panel-plantilla').style.display = "block";

    if (plantilla.length === 0) {
        contenedor.innerHTML = `<div style="grid-column: 1/-1; padding:40px; color:#94a3b8; text-align:center;">No hay jugadores registrados en ${nombreEquipo}.</div>`;
    } else {
        // ... (Tu l√≥gica de MVP y renderizado de cartas se mantiene igual abajo)
        const rankingInterno = [...plantilla].sort((a, b) => {
            if ((b.goles || 0) !== (a.goles || 0)) return (b.goles || 0) - (a.goles || 0);
            if ((a.pj || 0) !== (b.pj || 0)) return (a.pj || 0) - (b.pj || 0);
            return (a.roja || 0) - (b.roja || 0);
        });

        const idMvp = (rankingInterno[0].goles > 0) ? rankingInterno[0].id : null;
        
        contenedor.innerHTML = plantilla.map(j => {
            const fotoUrl = j.foto || 'https://via.placeholder.com/200x180?text=SIN+FOTO';
            const claseNombreCorto = j.nombre.length > 15 ? 'style="font-size: 10px;"' : '';
            const esMvp = (j.id === idMvp) ? 'card-mvp' : '';

            return `
            <div class="simple-card ${esMvp}">
                <div class="sc-admin-tools editor-only">
                    <button onclick="editarPj(${j.id})">‚úèÔ∏è</button>
                    <button onclick="eliminarPj(${j.id}, '${nombreEquipo}')">üóëÔ∏è</button>
                </div>
                <div class="sc-img-container">
                    <img src="${fotoUrl}">
                </div>
                <div class="sc-info">
                    <div class="sc-name" ${claseNombreCorto}>${j.nombre}</div>
                    <div class="sc-stats-grid">
                        <div class="sc-stat-item"><span>‚öΩ</span> ${j.goles || 0}</div>
                        <div class="sc-stat-item"><span>üèüÔ∏è</span> ${j.pj || 0}</div>
                        <div class="sc-stat-item" style="background:#fff9db;"><span>üü®</span> ${j.ama || 0}</div>
                        <div class="sc-stat-item" style="background:#fff5f5;"><span>üü•</span> ${j.roja || 0}</div>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    aplicarRestricciones();
    document.getElementById('panel-plantilla').scrollIntoView({ behavior: 'smooth' });
}
function guardarJugador() {
    if (!modoAdmin) return alert("Acci√≥n bloqueada: Permisos requeridos.");

    const nombre = document.getElementById('pj-nombre').value.trim();
    const curp = document.getElementById('pj-curp').value.trim().toUpperCase();
    const idEditando = document.getElementById('edit-pj-id').value;
    const nombreEquipoDestino = (equipoActual || "").trim().toUpperCase(); 
    // VALIDACI√ìN DE EMERGENCIA
    if (!nombreEquipoDestino) {
        return alert("‚ùå ERROR: No hay un equipo seleccionado. \nPor favor, selecciona un equipo de la lista o crea uno antes de a√±adir jugadores.");
    }

    if (!nombre || !curp) return alert("Por favor, ingresa Nombre y CURP.");

    // 1. Validaci√≥n de duplicados (A√±adimos toUpperCase por seguridad)
    const duplicado = db.jugadores.find(j => j.curp === curp && String(j.id) !== String(idEditando));
    if (duplicado) return alert(`¬°ERROR! El CURP ${curp} ya existe en el equipo: ${duplicado.equipo}`);

    // 2. L√≥gica de GUARDADO
    if (idEditando === "-1") {
        db.jugadores.push({ 
            id: Date.now(), 
            nombre: nombre, 
            curp: curp, 
            equipo: nombreEquipoDestino, // <--- Ahora es 100% seguro
            pj: 0, goles: 0, ama: 0, roja: 0, 
            foto: fotoBase64Temp || "" 
        });
    } else {
        const j = db.jugadores.find(x => String(x.id) === String(idEditando));
        if (j) {
            j.nombre = nombre; 
            j.curp = curp;
            // Si el jugador se mueve de equipo al editar, podr√≠as actualizar j.equipo aqu√≠ tambi√©n
            if (fotoBase64Temp) j.foto = fotoBase64Temp;
        }
    }

    // 3. Ordenar, Persistir y Limpiar (Tu c√≥digo actual est√° bien)
    db.jugadores.sort((a, b) => a.nombre.localeCompare(b.nombre));
    persist(); 
    
    fotoBase64Temp = "";
    const inputFoto = document.getElementById('pj-foto-file') || document.getElementById('foto-archivo');
    if(inputFoto) inputFoto.value = "";

    alert("‚úÖ ¬°Jugador guardado y lista ordenada!");
    
    limpiarFormularioJugador();

    // 6. REFRESCO SEGURO
    if (nombreEquipoDestino) {
        // Aseguramos que el t√≠tulo visual coincida con el dato guardado
        document.getElementById('tit-equipo').innerText = nombreEquipoDestino;
        verPlantilla(nombreEquipoDestino); 
    }
    
    if (typeof renderTodo === 'function') renderTodo();

    document.getElementById('body-plantilla').scrollIntoView({ behavior: 'smooth', block: 'end' });
}

function editarPj(id) {
    // Usamos String() para asegurar que la b√∫squeda funcione sin importar el origen del ID
    const j = db.jugadores.find(x => String(x.id) === String(id));
    if (!j) return;

    document.getElementById('pj-nombre').value = j.nombre;
    document.getElementById('pj-curp').value = j.curp || "";
    document.getElementById('edit-pj-id').value = j.id; // Guardamos el ID original

    // MOSTRAR FOTO ACTUAL
    const preview = document.getElementById('previsualizar-foto');
    if (j.foto) {
        preview.src = j.foto;
        preview.style.display = "inline-block";
        // IMPORTANTE: Reseteamos la variable temporal para que no se guarde 
        // la foto vieja como si fuera nueva a menos que el usuario la cambie.
        fotoBase64Temp = ""; 
    } else {
        preview.src = "";
        preview.style.display = "none";
    }
    
    // Opcional: Hacer scroll autom√°tico hacia el formulario para que el usuario vea que se carg√≥
    document.getElementById('pj-nombre').focus();
}

    	// --- L√ìGICA DE CALENDARIO CON ALTERNANCIA ---

	function generarCalendario() {
    if (rolActual !== 'admin') {
        alert("‚õî Solo el Administrador principal puede regenerar el calendario.");
        return;
    }
    
    if (!confirm("‚ö†Ô∏è ¬øEst√°s seguro? Se borrar√°n todos los resultados actuales.")) return;	

        if (db.equipos.length < 2) return alert("M√≠nimo 2 equipos");
        
        const numVueltas = parseInt(document.getElementById('vueltas').value);
        let eqs = db.equipos.map(e => e.nombre);
        
        if (eqs.length % 2 !== 0) eqs.push("DESCANSO");
        
        db.calendario = [];
        let n = eqs.length;
        let jornadasPrimeraVuelta = [];

        for (let i = 0; i < n - 1; i++) {
            let jor = { num: i + 1, partidos: [] };
            for (let j = 0; j < n / 2; j++) {
                let local = eqs[j];
                let visitante = eqs[n - 1 - j];
                
                if (local !== "DESCANSO" && visitante !== "DESCANSO") {
                    // ALTERNANCIA L/V: Si la jornada es par, invertimos el orden
                    if (i % 2 === 1) {
                        let temp = local;
                        local = visitante;
                        visitante = temp;
                    }

                    jor.partidos.push({
                        id: Math.random(),
                        l: local,
                        v: visitante,
                        score: "vs",
                        jugado: false,
                        inc: []
                    });
                }
            }
            jornadasPrimeraVuelta.push(jor);
            eqs.splice(1, 0, eqs.pop()); 
        }

        db.calendario = [...jornadasPrimeraVuelta];

        if (numVueltas === 2) {
            let totalIda = jornadasPrimeraVuelta.length;
            jornadasPrimeraVuelta.forEach((jorIda, idx) => {
                let jorVuelta = { num: totalIda + idx + 1, partidos: [] };
                jorIda.partidos.forEach(pIda => {
                    jorVuelta.partidos.push({
                        id: Math.random(),
                        l: pIda.v,
                        v: pIda.l,
                        score: "vs",
                        jugado: false,
                        inc: []
                    });
                });
                db.calendario.push(jorVuelta);
            });
        }

        persist();
        renderTodo();
        alert("CALENDARIO GENERADO");
	    }

// --- L√ìGICA DE CALENDARIO CON ALTERNANCIA ---
function generarCalendario() {
    if (rolActual !== 'admin') {
        alert("‚õî Solo el Administrador principal puede regenerar el calendario.");
        return;
    }
    
    if (!confirm("‚ö†Ô∏è ¬øEst√°s seguro? Se borrar√°n todos los resultados actuales.")) return;	

    if (db.equipos.length < 2) return alert("M√≠nimo 2 equipos");
    
    const numVueltas = parseInt(document.getElementById('vueltas').value);
    let eqs = db.equipos.map(e => e.nombre);
    
    if (eqs.length % 2 !== 0) eqs.push("DESCANSO");
    
    db.calendario = [];
    let n = eqs.length;
    let jornadasPrimeraVuelta = [];

    for (let i = 0; i < n - 1; i++) {
        let jor = { num: i + 1, partidos: [] };
        for (let j = 0; j < n / 2; j++) {
            let local = eqs[j];
            let visitante = eqs[n - 1 - j];
            
            if (local !== "DESCANSO" && visitante !== "DESCANSO") {
                if (i % 2 === 1) {
                    let temp = local;
                    local = visitante;
                    visitante = temp;
                }

                jor.partidos.push({
                    id: Math.random(),
                    l: local,
                    v: visitante,
                    score: "vs",
                    jugado: false,
                    inc: []
                });
            }
        }
        jornadasPrimeraVuelta.push(jor);
        eqs.splice(1, 0, eqs.pop()); 
    }

    db.calendario = [...jornadasPrimeraVuelta];

    if (numVueltas === 2) {
        let totalIda = jornadasPrimeraVuelta.length;
        jornadasPrimeraVuelta.forEach((jorIda, idx) => {
            let jorVuelta = { num: totalIda + idx + 1, partidos: [] };
            jorIda.partidos.forEach(pIda => {
                jorVuelta.partidos.push({
                    id: Math.random(),
                    l: pIda.v,
                    v: pIda.l,
                    score: "vs",
                    jugado: false,
                    inc: []
                });
            });
            db.calendario.push(jorVuelta);
        });
    }

    persist();
    renderTodo();
    alert("CALENDARIO GENERADO");
}

function renderCalendario() {
    const contenedor = document.getElementById('render-calendario');
    if (!contenedor) return;

    contenedor.innerHTML = ""; 
    if (!db.calendario || db.calendario.length === 0) {
        contenedor.innerHTML = `<div style="text-align:center; padding:40px; color:#94a3b8;">
            <div style="font-size:40px; margin-bottom:10px;">üìÖ</div>
            <p>A√∫n no hay jornadas generadas en el sistema.</p>
        </div>`;
        return;
    }

    // Definimos qui√©n tiene permiso de edici√≥n (Admin y Editor)
    const tienePermiso = (rolActual === 'admin' || rolActual === 'editor');

    let html = "";
    db.calendario.forEach(jornada => {
        html += `
        <div style="margin-top:30px; background:#fff; border-radius:15px; overflow:hidden; border:1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
            <div style="background:var(--primary); color:white; padding:15px; font-weight:900; text-align:center; letter-spacing:2px; text-transform:uppercase; font-size:14px;">
                JORNADA ${jornada.num}
            </div>`;
        
        jornada.partidos.forEach(p => {
            let botonAccion = "";
            
            if (p.jugado) {
                // PARTIDO FINALIZADO
                botonAccion = `
                    <div style="font-size:32px; font-weight:900; color:#1e293b; line-height:1;">${p.score}</div>
                    <div style="display:flex; flex-direction:column; gap:6px; margin-top:10px;">
                        <button onclick="verReporte(${p.id})" style="background:#3b82f6; color:white; border:none; padding:5px 12px; border-radius:6px; cursor:pointer; font-size:10px; font-weight:bold;">üìÑ REPORTE</button>
                        ${tienePermiso ? `
                            <button onclick="resolverProtesta(${p.id})" style="background:#e11d48; color:white; border:none; padding:5px 12px; border-radius:6px; cursor:pointer; font-size:10px; font-weight:bold;">üö´ PROTESTA</button>
                            <button onclick="resetearPartido(${p.id})" style="background:#64748b; color:white; border:none; padding:5px 12px; border-radius:6px; cursor:pointer; font-size:10px; font-weight:bold;">üîÑ RESETEAR</button>
                        ` : ''}
                    </div>`;
            } else {
                // PARTIDO PENDIENTE
                botonAccion = `
                    <div style="font-weight:900; color:#cbd5e1; font-size:20px; letter-spacing:2px;">VS</div>
                    <div style="display:flex; flex-direction:column; gap:6px; margin-top:10px;">
                        ${tienePermiso ? `
                            <button onclick="prepararCarga(${p.id})" style="background:var(--success); color:white; border:none; padding:6px 14px; border-radius:6px; cursor:pointer; font-size:11px; font-weight:bold;">CARGAR</button>
                            <button onclick="resolverDefault(${p.id})" style="background:#64748b; color:white; border:none; padding:6px 14px; border-radius:6px; cursor:pointer; font-size:11px; font-weight:bold;">DEFAULT</button>
                        ` : '<span style="color:#94a3b8; font-size:10px; font-weight:bold;">PENDIENTE</span>'}
                    </div>`;
            }

            const eqL = db.equipos.find(e => e.nombre === p.l) || {};
            const eqV = db.equipos.find(e => e.nombre === p.v) || {};

            html += `
                <div class="partido-row" style="display:flex; align-items:center; justify-content:space-between; padding:25px 15px; border-bottom:1px solid #f1f5f9;">
                    <div style="flex:1; display:flex; flex-direction:column; align-items:center; gap:12px;">
                        <img src="${eqL.logo || 'https://via.placeholder.com/60'}" style="width:60px; height:60px; object-fit:contain;">
                        <span style="font-size:14px; font-weight:800; text-align:center;">${p.l}</span>
                    </div>

                    <div style="flex:0.6; text-align:center; display:flex; flex-direction:column; align-items:center;">
                        ${botonAccion}
                    </div>

                    <div style="flex:1; display:flex; flex-direction:column; align-items:center; gap:12px;">
                        <img src="${eqV.logo || 'https://via.placeholder.com/60'}" style="width:60px; height:60px; object-fit:contain;">
                        <span style="font-size:14px; font-weight:800; text-align:center;">${p.v}</span>
                    </div>
                </div>`;
        });
        html += `</div>`;
    });
    contenedor.innerHTML = html;
}
function prepararCarga(id) {
    let p; 
    db.calendario.forEach(j => { 
        let x = j.partidos.find(part => part.id === id); 
        if(x) p = x; 
    });

    if (p.jugado) {
        alert("Este partido ya fue finalizado y no puede ser editado.");
        navegar('sec-calendario');
        return;
    }

    const eqLocal = db.equipos.find(e => e.nombre === p.l);
    const eqVisita = db.equipos.find(e => e.nombre === p.v);
    const jl = db.jugadores.filter(j => j.equipo === p.l).sort((a,b)=>a.nombre.localeCompare(b.nombre));
    const jv = db.jugadores.filter(j => j.equipo === p.v).sort((a,b)=>a.nombre.localeCompare(b.nombre));
    
    navegar('sec-partido', document.querySelectorAll('.nav-link')[2]);
    
document.getElementById('area-carga').innerHTML = `
    <div style="text-align:center; background: var(--primary); color:white; padding:20px; border-radius:12px; margin-bottom:20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        <div style="display:flex; justify-content:space-around; align-items:center;">
            <div style="flex:1;">
                <img src="${eqLocal.logo || ''}" onerror="this.src='https://via.placeholder.com/80?text=LOGO'" style="width:80px; height:80px; object-fit:contain; background:white; border-radius:10px; padding:5px; border: 2px solid var(--accent);">
                <h3 style="margin:10px 0 0; font-size:18px; text-transform:uppercase;">${p.l}</h3>
            </div>

            <div style="flex:1;">
                <div style="font-size:12px; opacity:0.6; margin-bottom:5px;">MARCADOR</div>
                <h1 style="margin:0; font-size:55px; letter-spacing: 5px;"><span id="live-gl">0</span> - <span id="live-gv">0</span></h1>
            </div>

            <div style="flex:1;">
                <img src="${eqVisita.logo || ''}" onerror="this.src='https://via.placeholder.com/80?text=LOGO'" style="width:80px; height:80px; object-fit:contain; background:white; border-radius:10px; padding:5px; border: 2px solid var(--accent);">
                <h3 style="margin:10px 0 0; font-size:18px; text-transform:uppercase;">${p.v}</h3>
            </div>
        </div>

        <div style="margin-top:20px; display:grid; grid-template-columns: 1fr 1fr; gap:15px; background: rgba(255,255,255,0.1); padding:15px; border-radius:10px;">
            <div>
                <label style="display:block; font-size: 10px; font-weight: bold; color: var(--accent); margin-bottom: 5px; text-transform:uppercase;">üèüÔ∏è Estadio:</label>
                <input type="text" id="input-estadio" placeholder="Nombre de la sede" style="width:100%; padding:8px; border-radius:6px; border:none; color:#1e293b; font-size:13px;">
            </div>
            <div>
                <label style="display:block; font-size: 10px; font-weight: bold; color: var(--accent); margin-bottom: 5px; text-transform:uppercase;">‚öñÔ∏è √Årbitro:</label>
                <input type="text" id="input-arbitro" placeholder="Nombre del central" style="width:100%; padding:8px; border-radius:6px; border:none; color:#1e293b; font-size:13px;">
            </div>
        </div>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
        <div style="background:#fff; padding:15px; border-radius:10px; border:1px solid #eee;">
            <h4 style="margin-top:0; color:var(--primary); border-bottom:2px solid #eee; padding-bottom:5px;">üõ°Ô∏è ${p.l}</h4>
            ${jl.map(j => statInput(j, 'L')).join('')}
            ${statInput({id: 'AGL', nombre: 'AUTOGOL', equipo: p.l}, 'L', true)}
        </div>
        <div style="background:#fff; padding:15px; border-radius:10px; border:1px solid #eee;">
            <h4 style="margin-top:0; color:var(--primary); border-bottom:2px solid #eee; padding-bottom:5px;">üõ°Ô∏è ${p.v}</h4>
            ${jv.map(j => statInput(j, 'V')).join('')}
            ${statInput({id: 'AGV', nombre: 'AUTOGOL', equipo: p.v}, 'V', true)}
        </div>
    </div>

    <div style="margin-top:20px; background:#fff; border:1px solid #ddd; border-radius:12px; overflow:hidden;">
        <div style="background:#f1f5f9; padding:10px; font-weight:bold; text-align:center; border-bottom:1px solid #ddd;">
            üìù INCIDENCIAS DEL ENCUENTRO
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:0; min-height:80px;">
            <div id="incidencias-L" style="padding:15px; border-right:1px solid #eee; font-size:13px; background:#fafafa;">
                <small style="color:#64748b; display:block; margin-bottom:5px;">LOCAL</small>
            </div>
            <div id="incidencias-V" style="padding:15px; font-size:13px;">
                <small style="color:#64748b; display:block; margin-bottom:5px;">VISITANTE</small>
            </div>
        </div>
    </div>

    <button onclick="guardarPartido(${id})" class="btn-main" style="margin-top:20px; height:60px; font-size:20px; background:var(--success); box-shadow:0 4px 10px rgba(16,185,129,0.3);">
        ‚úÖ FINALIZAR Y GUARDAR PARTIDO
    </button>`;
}

function statInput(j, lado, esAutogol = false) {
    const displayTarjetas = esAutogol ? 'none' : 'flex';
    const bgFila = esAutogol ? 'background: #fff1f2;' : 'background: white;';
    
    // Los jugadores normales inician con opacidad baja y sin eventos de clic
    const estiloInicial = esAutogol ? '' : 'opacity: 0.5; pointer-events: none;';

    return `
    <div class="stat-input-row" 
         id="row-${j.id}" 
         data-jid="${j.id}" 
         data-nombre="${j.nombre}" 
         data-equipo="${j.equipo}" 
         data-lado="${lado}"
         data-es-ag="${esAutogol}"
         data-g="0" data-a="0" data-r="0" data-da="0"
         style="display:flex; align-items:center; justify-content:space-between; padding:5px; margin-bottom:5px; border-radius:6px; border:1px solid #eee; transition: all 0.3s; ${bgFila}">
        
        <div style="display:flex; align-items:center; gap:5px; pointer-events: auto;">
            <input type="checkbox" class="disp" 
                   ${esAutogol ? 'style="display:none"' : ''} 
                   onchange="controlarFila('${j.id}', this)">
            <span style="font-size:12px; font-weight:${esAutogol ? 'bold' : 'normal'}; color:${esAutogol ? '#e11d48' : 'black'}">
                ${j.nombre}
            </span>
        </div>
        
        <div id="controles-${j.id}" style="display:flex; gap:5px; align-items:center; ${estiloInicial}">
            <div onclick="accionarStat('${j.id}', 'g')" id="btn-g-${j.id}" 
                 style="width:35px; height:30px; border:1px solid #ddd; display:flex; align-items:center; justify-content:center; cursor:pointer; border-radius:4px; background:white;">
                 ‚öΩ<span class="val" style="font-size:10px; margin-left:2px;">0</span>
            </div>
            
            <div style="display:${displayTarjetas}; gap:5px;">
                <div onclick="accionarStat('${j.id}', 'a')" id="btn-a-${j.id}" style="width:35px; height:30px; border:1px solid #ddd; display:flex; align-items:center; justify-content:center; cursor:pointer; border-radius:4px; background:white;">üü®</div>
                <div onclick="accionarStat('${j.id}', 'r')" id="btn-r-${j.id}" style="width:35px; height:30px; border:1px solid #ddd; display:flex; align-items:center; justify-content:center; cursor:pointer; border-radius:4px; background:white;">üü•</div>
            </div>
        </div>
    </div>`;
}

function accionarStat(id, tipo) {
    const row = document.getElementById(`row-${id}`);
    const btnA = document.getElementById(`btn-a-${id}`);
    const btnR = document.getElementById(`btn-r-${id}`);
    const btnG = document.getElementById(`btn-g-${id}`);

    // Detectar estado actual
    const tieneRojaDirecta = parseInt(row.dataset.r) === 1;
    const tieneDobleA = row.dataset.da === "1";
    const expulsado = tieneRojaDirecta || tieneDobleA;

    // BLOQUEO DE GOLES
    if (tipo === 'g') {
        if (expulsado) return; 
        
        let goles = parseInt(row.dataset.g) + 1;
        row.dataset.g = goles;
        btnG.querySelector('.val').innerText = goles;
        btnG.style.background = "#dcfce7";
    }

    // L√ìGICA DE AMARILLAS (CORREGIDA)
    if (tipo === 'a') {
        if (tieneRojaDirecta) return;

        let amarillasActuales = parseInt(row.dataset.a);

        if (amarillasActuales === 0) {
            // Primera Amarilla: Normal
            row.dataset.a = 1;
            row.dataset.da = 0;
            btnA.style.background = "#fef08a"; 
            btnA.innerHTML = "üü®";
        } 
        else if (amarillasActuales === 1) {
            // SEGUNDA AMARILLA -> SE CONVIERTE EN ROJA
            // Ponemos 'a' en 0 para que no sume amarillas al acumulado del torneo
            row.dataset.a = 0; 
            row.dataset.da = 1; // Marcamos que fue por doble amarilla
            row.dataset.r = 1;  // Marcamos que tiene roja para el guardado
            
            btnA.innerHTML = "üü®üü•";
            btnA.style.background = "#fee2e2";
            // Sincronizamos el bot√≥n de roja directa por si acaso
            btnR.style.background = "#fecaca"; 
        } 
        else {
            // Reset total
            row.dataset.a = 0;
            row.dataset.da = 0;
            row.dataset.r = 0;
            btnA.innerHTML = "üü®";
            btnA.style.background = "white";
            btnR.style.background = "white";
        }
    }

    // L√ìGICA DE ROJA DIRECTA
    if (tipo === 'r') {
        let roja = parseInt(row.dataset.r);
        if (roja === 0) {
            row.dataset.r = 1;
            btnR.style.background = "#fecaca";
        } else {
            // Si quitamos la roja, tambi√©n quitamos el estado de Doble Amarilla
            row.dataset.r = 0;
            row.dataset.da = 0;
            row.dataset.a = 0;
            btnR.style.background = "white";
            btnA.innerHTML = "üü®";
            btnA.style.background = "white";
        }
    }

    actualizarMarcadorVivo();
}


function actualizarMarcadorVivo() {
    let golesL = 0, golesV = 0;
    let htmlL = "", htmlV = "";

    document.querySelectorAll('.stat-input-row').forEach(row => {
        const checkJugo = row.querySelector('.disp');
        const esAG = row.dataset.esAg === "true";
        
        // Si no es autogol y el checkbox NO est√° marcado, ignoramos esta fila
        if (!esAG && checkJugo && !checkJugo.checked) {
            return; 
        }

        const g = parseInt(row.dataset.g) || 0;
        const a = parseInt(row.dataset.a) || 0;
        const r = parseInt(row.dataset.r) || 0;
        const da = row.dataset.da === "1"; // Doble Amarilla
        const nombre = row.dataset.nombre;
        const lado = row.dataset.lado;

        // Sumar goles al marcador global
        if (lado === 'L') golesL += g; else golesV += g;

        let icons = "";
        
        // ‚öΩ L√ìGICA DE GOLES
        if (g > 0) {
            if (esAG) {
                icons += ` <b style="color: #e11d48;">(AG) ‚öΩx${g}</b>`;
            } else {
                icons += ` ‚öΩx${g}`;
            }
        }
        
        // üü®/üü• L√ìGICA DE TARJETAS (CORREGIDA)
        if (da) {
            // Si es Doble Amarilla, solo mostramos el combo y omitimos la R sola
           icons += `
        <div class="doble-tarjeta-container" title="Expulsi√≥n por Doble Amarilla">
            <div class="card-mini card-yellow"></div>
            <div class="card-mini card-red"></div>
        </div>
    `;
} else {
    // Tarjetas normales si no es Doble Amarilla
    if (a > 0) icons += ` <span style="color:#ffeb3b; font-size:16px;">üü®</span>`;
    if (r > 0) icons += ` <span style="color:#f44336; font-size:16px;">üü•</span>`;
}

        // Mostrar fila si hubo actividad
        if (g > 0 || a > 0 || r > 0 || da) {
            const estiloNombre = esAG ? 'style="color: #e11d48; font-weight: bold;"' : '';
            const linea = `<div style="margin-bottom:2px;">‚Ä¢ <span ${estiloNombre}>${nombre}</span>${icons}</div>`;
            
            if (lado === 'L') htmlL += linea; else htmlV += linea;
        }
    });

    // Actualizar la interfaz
    document.getElementById('live-gl').innerText = golesL;
    document.getElementById('live-gv').innerText = golesV;
    
    // Mantener los encabezados de LOCAL/VISITANTE si quieres, o solo el HTML
    const labelL = `<small style="color:#64748b; display:block; margin-bottom:5px;">LOCAL</small>`;
    const labelV = `<small style="color:#64748b; display:block; margin-bottom:5px;">VISITANTE</small>`;

    document.getElementById('incidencias-L').innerHTML = htmlL ? labelL + htmlL : labelL + "Sin incidencias";
    document.getElementById('incidencias-V').innerHTML = htmlV ? labelV + htmlV : labelV + "Sin incidencias";
}
   function guardarPartido(idPartido) {
    // 0. BLOQUEO DE SEGURIDAD
    const btnGuardar = event.target; 
    if (btnGuardar && btnGuardar.tagName === 'BUTTON') {
        btnGuardar.disabled = true;
        btnGuardar.innerText = "PROCESANDO...";
    }

    // --- NUEVA CAPTURA DE DATOS T√âCNICOS ---
    const estadioVal = document.getElementById('input-estadio').value.trim();
    const arbitroVal = document.getElementById('input-arbitro').value.trim();

    // Validaci√≥n opcional: Si quieres obligar a llenar estos campos, quita el comentario:
    // if(!estadioVal || !arbitroVal) { 
    //    alert("Por favor, ingresa el Estadio y el √Årbitro."); 
    //    btnGuardar.disabled = false; btnGuardar.innerText = "‚úÖ FINALIZAR Y GUARDAR PARTIDO";
    //    return; 
    // }

    let gl = parseInt(document.getElementById('live-gl').innerText);
    let gv = parseInt(document.getElementById('live-gv').innerText);
    
    const detalleL = document.getElementById('incidencias-L').innerHTML;
    const detalleV = document.getElementById('incidencias-V').innerHTML;

    // 1. ACTUALIZAR ESTADO DEL PARTIDO Y REPORTE
    let partidoObj;
    db.calendario.forEach(j => {
        let p = j.partidos.find(x => x.id === idPartido);
        if(p) {
            if(p.jugado) return alert("Este partido ya fue registrado anteriormente.");
            
            p.score = `${gl} - ${gv}`;
            p.jugado = true;
            
            // --- ASIGNACI√ìN DE DATOS T√âCNICOS AL PARTIDO ---
            p.estadio = estadioVal || "Sede Principal";
            p.arbitro = arbitroVal || "Central Designado";
            
            p.reporteHtml = { local: detalleL, visita: detalleV };
            partidoObj = p;
        }
    });

    if(!partidoObj) return;

    // 2. ACTUALIZAR TABLA DE POSICIONES (EQUIPOS)
    const eqL = db.equipos.find(e => e.nombre === partidoObj.l);
    const eqV = db.equipos.find(e => e.nombre === partidoObj.v);

    eqL.pj++; eqV.pj++;
    eqL.gf += gl; eqL.gc += gv;
    eqV.gf += gv; eqV.gc += gl;

    if(gl > gv) { eqL.g++; eqL.pts += 3; eqV.p++; }
    else if(gv > gl) { eqV.g++; eqV.pts += 3; eqL.p++; }
    else { eqL.e++; eqV.e++; eqL.pts += 1; eqV.pts += 1; }

    // Variables temporales para modificar los reportes antes de guardar
    let htmlReporteL = detalleL;
    let htmlReporteV = detalleV;

    // 3. ACTUALIZAR JUGADORES
    document.querySelectorAll('.stat-input-row').forEach(row => {
        const esAG = row.dataset.esAg === "true";
        if (esAG) return; 

        const checkJugo = row.querySelector('.disp');
        if (checkJugo && !checkJugo.checked) return;

        const jid = parseInt(row.dataset.jid);
        const j = db.jugadores.find(x => x.id === jid);
        
        if(j) {
            j.pj = (j.pj || 0) + 1;
            j.goles = (j.goles || 0) + (parseInt(row.dataset.g) || 0);
            
            const da = row.dataset.da === "1"; 
            if(da) {
                j.roja = (j.roja || 0) + 1;
                const itemRoja = `
                    <div class="incidencia-item" style="margin-top:5px; padding:2px 5px; border-left:3px solid #ef4444; background:#fff5f5;">
                        <span style="color:#ef4444;">üü•</span> <b>${j.nombre}</b> 
                        <small style="color:#64748b; display:block; margin-left:20px;">Expulsi√≥n por Doble Amarilla</small>
                    </div>`;
                
                if (j.equipo === partidoObj.l) { htmlReporteL += itemRoja; } 
                else { htmlReporteV += itemRoja; }
            } else {
                j.ama = (j.ama || 0) + (parseInt(row.dataset.a) || 0);
                j.roja = (j.roja || 0) + (parseInt(row.dataset.r) || 0);
            }
        }
    });

    // ACTUALIZAMOS EL OBJETO PARTIDO CON EL HTML MODIFICADO
    partidoObj.reporteHtml = { local: htmlReporteL, visita: htmlReporteV };

    // 4. PERSISTENCIA Y LIMPIEZA
    persist();
    renderTodo();
    
    const areaCarga = document.getElementById('area-carga');
    if(areaCarga) areaCarga.innerHTML = `<p style="text-align:center; padding:20px; color:#64748b;">‚úÖ Partido guardado. Selecciona otro juego del calendario.</p>`;

    alert("Partido finalizado y estad√≠sticas actualizadas.");
    
    const btnNavCalendario = document.querySelector('button[onclick*="sec-calendario"]');
    navegar('sec-calendario', btnNavCalendario);
    
    if(typeof renderCalendario === 'function') renderCalendario();
}

    function verReporte(idPartido) {
    let partido;
    let jornadaNum = 0;
    
    // --- ESTA ES LA CLAVE: Priorizamos el nombre guardado en la DB ---
    const nombreTorneoParaReporte = db.nombreTorneoActual || nombreTorneoActual;

    db.calendario.forEach(j => {
        let p = j.partidos.find(x => x.id === idPartido);
        if(p) {
            partido = p;
            jornadaNum = j.num;
        }
    });

    if(!partido || !partido.reporteHtml) return alert("No hay reporte detallado.");

    const logoL = db.equipos.find(e => e.nombre === partido.l)?.logo || '';
    const logoV = db.equipos.find(e => e.nombre === partido.v)?.logo || '';
    
    const ahora = new Date();
    const fechaFomateada = ahora.toLocaleDateString() + " - " + ahora.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

    const win = window.open('', '_blank');
    win.document.write(`
        <html>
        <head>
            <title>Reporte J${jornadaNum} - ${partido.l} vs ${partido.v}</title>
            <style>
                body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 40px; text-align: center; color: #1e293b; background: #f8fafc; }
                .box { border-radius: 20px; padding: 40px; background: white; display: inline-block; min-width: 700px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; position: relative; }
                .top-bar { display: flex; justify-content: space-between; margin-bottom: 30px; font-size: 12px; color: #64748b; font-weight: bold; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; }
                .header-title { font-weight: 900; color: #1e293b; letter-spacing: 3px; margin-bottom: 5px; font-size: 20px; text-transform: uppercase; }
                .sub-title { color: #3b82f6; font-weight: bold; margin-bottom: 10px; font-size: 14px; text-transform: uppercase; }
                .info-tecnica { display: flex; justify-content: center; gap: 30px; margin-bottom: 30px; font-size: 12px; color: #64748b; font-weight: 600; text-transform: uppercase; }
                .scoreboard { display: flex; align-items: center; justify-content: center; gap: 40px; margin: 30px 0; }
                .team-info { flex: 1; text-align: center; max-width: 200px; }
                .logo-img { width: 120px; height: 120px; object-fit: contain; margin-bottom: 15px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.1)); }
                .team-name { font-size: 20px; font-weight: 800; text-transform: uppercase; color: #0f172a; line-height: 1.2; }
                .score-display { font-size: 70px; font-weight: 900; color: #ffffff; background: #1e293b; padding: 10px 40px; border-radius: 20px; min-width: 140px; box-shadow: 0 8px 0 #3b82f6; }
                .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 50px; text-align: left; margin-top: 40px; border-top: 2px solid #f1f5f9; padding-top: 30px; }
                h3 { font-size: 14px; color: #3b82f6; border-left: 4px solid #3b82f6; padding-left: 10px; margin-bottom: 20px; text-transform: uppercase; }
                .incidencia-item { margin-bottom: 6px; font-size: 15px; color: #334155; }
                .footer-note { margin-top: 40px; font-size: 11px; color: #94a3b8; font-style: italic; }
                .btn-print { margin-top: 30px; padding: 15px 40px; cursor: pointer; background: #3b82f6; color: white; border: none; border-radius: 50px; font-weight: bold; font-size: 14px; box-shadow: 0 4px 14px rgba(59, 130, 246, 0.4); }
                @media print { .btn-print { display: none; } body { background: white; padding: 0; } .box { box-shadow: none; border: 1px solid #eee; } }
            </style>
        </head>
        <body>
            <div class="box">
                <div class="top-bar">
                    <span>${nombreTorneoParaReporte}</span>
                    <span>JORNADA ${jornadaNum}</span>
                    <span>ID PARTIDO: #${idPartido.toString().slice(-4)}</span>
                </div>
                
                <div class="header-title">${nombreTorneoParaReporte}</div>	
                <div class="sub-title">${db.nombreTemporada || "TEMPORADA 2026"}</div>

                <div class="info-tecnica">
                    <span>üèüÔ∏è Estadio: ${partido.estadio || 'Sede Principal'}</span>
                    <span>‚öñÔ∏è √Årbitro: ${partido.arbitro || 'Central designado'}</span>
                </div>
                
                <div class="scoreboard">
                    <div class="team-info">
                        <img src="${logoL}" onerror="this.src='https://via.placeholder.com/120?text=LOGO'" class="logo-img">
                        <div class="team-name">${partido.l}</div>
                    </div>
                    
                    <div class="score-display">${partido.score}</div>
                    
                    <div class="team-info">
                        <img src="${logoV}" onerror="this.src='https://via.placeholder.com/120?text=LOGO'" class="logo-img">
                        <div class="team-name">${partido.v}</div>
                    </div>
                </div>

                <div class="grid">
                    <div>
                        <h3>Eventos: ${partido.l}</h3>
                        <div class="incidencia-item">${partido.reporteHtml.local || 'Sin incidencias registradas'}</div>
                    </div>
                    <div>
                        <h3>Eventos: ${partido.v}</h3>
                        <div class="incidencia-item">${partido.reporteHtml.visita || 'Sin incidencias registradas'}</div>
                    </div>
                </div>

                <div class="footer-note">Este documento es una representaci√≥n digital del encuentro. Generado el: ${fechaFomateada}</div>
                
                <button class="btn-print" onclick="window.print()">üñ®Ô∏è IMPRIMIR REPORTE OFICIAL</button>
            </div>
        </body>
        </html>
    `);
}
function renderTodo() {
    // 1. ORDENAR DATOS BASE
    db.equipos.sort((a, b) => a.nombre.localeCompare(b.nombre));
    db.jugadores.sort((a, b) => a.nombre.localeCompare(b.nombre));

    // 2. RENDERIZAR COMPONENTES
    renderEquipos();
    renderCalendario();
    renderGoleadores();
    
    // IMPORTANTE: Llamamos a la funci√≥n que lee el SELECTOR
    renderDisciplina(); 
    
    if (typeof renderResumenInicio === 'function') renderResumenInicio();

    // 3. TABLA DE POSICIONES
    const t = [...db.equipos].sort((a,b) => b.pts - a.pts || (b.gf-b.gc) - (a.gf-a.gc));
    const bodyTabla = document.getElementById('body-tabla');
    if(bodyTabla) {
        bodyTabla.innerHTML = t.map((e,i) => `
            <tr>
                <td>${i+1}</td>
                <td style="text-align:left"><img src="${e.logo || ''}" class="img-tabla"><b>${e.nombre}</b></td>
                <td>${e.pj}</td><td>${e.g||0}</td><td>${e.e||0}</td><td>${e.p||0}</td>
                <td>${e.gf}</td><td>${e.gc}</td><td>${e.gf-e.gc}</td><td><b>${e.pts}</b></td>
            </tr>`).join('');
    }

    if (typeof aplicarRestricciones === 'function') aplicarRestricciones();
}
// 1. FUNCIONES DE ACTUALIZACI√ìN Y RENDERIZADO
function actualizarGoles(idx, campo, valor) {
    db.playoffs.llaves[idx][campo] = parseInt(valor) || 0;
    persist();
    renderPlayoffs(); // Esto refresca el Global visualmente al instante
}

function renderPlayoffs() {
    const p = db.playoffs;
    if (!p.llaves || p.llaves.length === 0) return;

    let nombreFase = "";
    if (p.faseActual === 8) nombreFase = "CUARTOS DE FINAL";
    else if (p.faseActual === 4) nombreFase = "SEMIFINALES";
    else if (p.faseActual === 2) nombreFase = "GRAN FINAL";

    let html = `<div style="display:grid; gap:20px; margin-top:20px;">
                <h2 style="text-align:center; color:var(--primary); margin-bottom:5px;">${nombreFase}</h2>
                <p style="text-align:center; font-size:12px; color:#64748b; margin-top:0;">
                    Formato: ${p.tipoDuelo === 2 ? 'Ida y Vuelta' : 'Partido √önico'}
                </p>`;

    p.llaves.forEach((llave, i) => {
        const esIdaVuelta = (p.tipoDuelo === 2);
        // L√≥gica de suma corregida para el Global
        const totalSup = esIdaVuelta ? (llave.gIdaSup + llave.gVtaSup) : llave.gIdaSup;
        const totalInf = esIdaVuelta ? (llave.gIdaInf + llave.gVtaInf) : llave.gIdaInf;

        html += `
            <div style="border:2px solid #3b82f6; border-radius:12px; background:#fff; overflow:hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
                <div style="padding:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:10px; color:#94a3b8; width:45px;">${esIdaVuelta ? 'IDA' : '√öNICO'}</span>
                        <div style="flex:1; text-align:right;">${esIdaVuelta ? llave.inf : '<b>'+llave.sup+'</b>'}</div>
                        <div style="margin:0 15px;">
                            <input type="number" value="${esIdaVuelta ? llave.gIdaInf : llave.gIdaSup}" oninput="actualizarGoles(${i}, '${esIdaVuelta ? 'gIdaInf' : 'gIdaSup'}', this.value)" style="width:45px; text-align:center; border:1px solid #cbd5e1; border-radius:4px;"> - 
                            <input type="number" value="${esIdaVuelta ? llave.gIdaSup : llave.gIdaInf}" oninput="actualizarGoles(${i}, '${esIdaVuelta ? 'gIdaSup' : 'gIdaInf'}', this.value)" style="width:45px; text-align:center; border:1px solid #cbd5e1; border-radius:4px;">
                        </div>
                        <div style="flex:1; text-align:left;">${esIdaVuelta ? llave.sup : llave.inf}</div>
                    </div>

                    ${esIdaVuelta ? `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px; padding-top:10px; border-top:1px dashed #eee;">
                        <span style="font-size:10px; color:#94a3b8; width:45px;">VUELTA</span>
                        <div style="flex:1; text-align:right;"><b>${llave.sup}</b></div>
                        <div style="margin:0 15px;">
                            <input type="number" value="${llave.gVtaSup}" oninput="actualizarGoles(${i}, 'gVtaSup', this.value)" style="width:45px; text-align:center; border:1px solid #cbd5e1; border-radius:4px;"> - 
                            <input type="number" value="${llave.gVtaInf}" oninput="actualizarGoles(${i}, 'gVtaInf', this.value)" style="width:45px; text-align:center; border:1px solid #cbd5e1; border-radius:4px;">
                        </div>
                        <div style="flex:1; text-align:left;">${llave.inf}</div>
                    </div>` : ''}
                </div>
                <div style="background:#f8fafc; padding:10px; text-align:center; border-top:1px solid #e2e8f0;">
                    <div style="font-size:14px; font-weight:bold;">
                        GLOBAL: ${llave.sup} ${totalSup} - ${totalInf} ${llave.inf}
                    </div>
                </div>
            </div>`;
    });

    let textoBoton = p.faseActual === 2 ? "üèÜ FINALIZAR TORNEO" : "‚û°Ô∏è AVANZAR SIGUIENTE FASE";
    html += `<button onclick="avanzarFase()" class="btn-main" style="background:var(--success); height:50px;">${textoBoton}</button>`;
    
    document.getElementById('render-playoffs').innerHTML = html;
}

// 2. FUNCI√ìN DE GENERACI√ìN INICIAL
function generarCrucesPlayoffs() {
    const cantidad = parseInt(document.getElementById('p-formato').value);
    const tipoDuelo = parseInt(document.getElementById('p-tipo-duelo')?.value || 2); // Por defecto ida/vuelta si no existe el select
    
    const clasificados = [...db.equipos]
        .sort((a,b) => b.pts - a.pts || (b.gf-b.gc) - (a.gf-a.gc))
        .slice(0, cantidad);

    if (clasificados.length < cantidad) return alert("No hay suficientes equipos.");

    db.playoffs = { faseActual: cantidad, tipoDuelo: tipoDuelo, llaves: [] };

    for (let i = 0; i < cantidad / 2; i++) {
        db.playoffs.llaves.push({
            sup: clasificados[i].nombre,
            inf: clasificados[cantidad - 1 - i].nombre,
            gIdaInf: 0, gIdaSup: 0, gVtaSup: 0, gVtaInf: 0
        });
    }
    renderPlayoffs();
}

// 3. FUNCI√ìN DE AVANCE Y CAMPE√ìN (L√ìGICA DE DESEMPATE)
function avanzarFase() {
    const p = db.playoffs;
    const ordenTabla = [...db.equipos]
        .sort((a,b) => b.pts - a.pts || (b.gf-b.gc) - (a.gf-a.gc))
        .map(e => e.nombre);

    const esLaFinal = (p.faseActual === 2);

    const ganadores = p.llaves.map(ll => {
        const esIdaVuelta = (p.tipoDuelo === 2);
        const totalSup = esIdaVuelta ? (ll.gIdaSup + ll.gVtaSup) : ll.gIdaSup;
        const totalInf = esIdaVuelta ? (ll.gIdaInf + ll.gVtaInf) : ll.gIdaInf;

        if (totalSup === totalInf) {
            if (esLaFinal) {
                let m = "";
                while (!m) {
                    m = prompt(`EMPATE GLOBAL (${totalSup}-${totalInf}).\nEscriba el nombre del CAMPE√ìN:\n1. ${ll.sup}\n2. ${ll.inf}`);
                    if (m !== ll.sup && m !== ll.inf) m = "";
                }
                return m;
            } else {
                // Ventaja deportiva
                return ordenTabla.indexOf(ll.sup) < ordenTabla.indexOf(ll.inf) ? ll.sup : ll.inf;
            }
        }
        return totalSup > totalInf ? ll.sup : ll.inf;
    });

    if (esLaFinal) {
        const campeon = ganadores[0];
        const eq = db.equipos.find(e => e.nombre === campeon);
        const logo = eq?.logo || 'https://via.placeholder.com/150?text=SIN+LOGO';

        document.getElementById('render-playoffs').innerHTML = `
            <div style="text-align:center; padding:40px; background:white; border:5px solid #fbbf24; border-radius:20px;">
                <h1 style="font-size:60px; margin:0;">üèÜ</h1>
                <h2 style="color:#b45309;">¬°EL CAMPE√ìN ES!</h2>
                <div style="margin:20px auto; width:180px; height:180px; border:4px solid #fbbf24; border-radius:50%; display:flex; align-items:center; justify-content:center; background:#f8fafc;">
                    <img src="${logo}" style="max-width:140px; max-height:140px; object-fit:contain;">
                </div>
                <h1 style="font-size:45px; color:var(--primary); text-transform:uppercase;">${campeon}</h1>
                <button onclick="location.reload()" class="btn-main" style="margin-top:20px; background:var(--primary)">IR A CALENDARIO</button>
            </div>`;
        return;
    }

    // Generar siguiente fase re-sembrando por posici√≥n en tabla
    const nuevaFase = p.faseActual / 2;
    p.faseActual = nuevaFase;
    let nuevasLlaves = [];
    for (let i = 0; i < ganadores.length; i += 2) {
        const p1 = ganadores[i];
        const p2 = ganadores[i+1];
        const mejorP1 = ordenTabla.indexOf(p1) < ordenTabla.indexOf(p2);
        nuevasLlaves.push({
            sup: mejorP1 ? p1 : p2,
            inf: mejorP1 ? p2 : p1,
            gIdaInf: 0, gIdaSup: 0, gVtaSup: 0, gVtaInf: 0
        });
    }
    p.llaves = nuevasLlaves;
    persist();
    renderPlayoffs();
	setTimeout(aplicarRestricciones, 50);
}

    renderTodo();

function prepararImpresionGoleadores() {
    const contenedor = document.getElementById('diseno-goleadores-pro');
    
    if (!contenedor || contenedor.innerHTML.trim() === "") {
        return alert("Error: No hay datos de goleadores en pantalla.");
    }

    // --- TRIPLE SEGURIDAD PARA EL NOMBRE ---
    let nombreFinal = "TORNEO SIN NOMBRE";
    
    if (typeof db !== 'undefined' && db.nombreTorneoActual) {
        nombreFinal = db.nombreTorneoActual;
    } else if (typeof nombreTorneoActual !== 'undefined' && nombreTorneoActual) {
        nombreFinal = nombreTorneoActual;
    } else {
        // Intenta leerlo directamente del banner azul de la app si existe
        const banner = document.querySelector('.header-banner h1, #header h1');
        if(banner) nombreFinal = banner.innerText;
    }

    const nombreTemp = (typeof db !== 'undefined' && db.nombreTemporada) ? db.nombreTemporada : "2026";
    // ---------------------------------------

    const contenidoOriginal = contenedor.innerHTML;

    const headerImpresion = document.createElement('div');
    headerImpresion.id = "temp-header-goleadores";
    headerImpresion.innerHTML = `
        <div style="text-align:center; padding: 20px; border: 2px solid #ef4444; border-radius: 15px; margin-bottom: 25px; background: #fffafb !important; color: #1e293b !important; font-family: Arial, sans-serif;">
            <h1 style="margin:0; font-size:32px; text-transform:uppercase; font-weight:bold;">
                ${nombreFinal}
            </h1>
            <div style="background:#ef4444 !important; color:white !important; display:inline-block; padding:5px 20px; border-radius:50px; font-weight:bold; margin-top:10px; text-transform:uppercase; font-size:12px; -webkit-print-color-adjust: exact;">
                Reporte Oficial de Goleo
            </div>
            <h3 style="margin:10px 0 0; color:#64748b !important; font-size:16px;">${nombreTemp}</h3>
        </div>
    `;
    
    contenedor.prepend(headerImpresion);

    const estilo = document.createElement('style');
    estilo.id = "print-temp";
    estilo.innerHTML = `
        @media print {
            nav, #auth-panel, .no-print, .nav-bar, .btn-main, header, footer { 
                display: none !important; 
            }
            .seccion { 
                display: none !important; 
            }
            #sec-goleadores { 
                display: block !important; 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100% !important;
            }
            #temp-header-goleadores { 
                display: block !important; 
                visibility: visible !important;
            }
            #temp-header-goleadores h1 {
                color: #1e293b !important;
            }
            * { 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
            }
        }
    `;
    document.head.appendChild(estilo);

    setTimeout(() => {
        window.print();
        estilo.remove();
        contenedor.innerHTML = contenidoOriginal;
    }, 500);
}function buscarJugador() {
    const input = document.getElementById('input-busqueda');
    const contenedor = document.getElementById('resultados-busqueda');
    
    if (!input || !contenedor) return;
    const texto = input.value.toLowerCase().trim();

    // 1. Calcular Ranking Din√°mico
    let rankeados = db.jugadores.map(j => {
        const pts = (j.goles * 10) + (j.pj * 2) - (j.ama * 3) - (j.roja * 10);
        return { ...j, puntos: pts };
    }).sort((a, b) => b.puntos - a.puntos);

    // 2. L√≥gica de Filtrado
    let encontrados;
    if (texto === "") {
        encontrados = rankeados;
    } else {
        encontrados = rankeados.filter(j => 
            j.nombre.toLowerCase().includes(texto) || (j.curp && j.curp.toLowerCase().includes(texto))
        );
    }

    if (encontrados.length === 0) {
        contenedor.innerHTML = "<p style='color:gray; text-align:center; padding:20px;'>Sin resultados</p>";
        return;
    }

    // 3. Renderizar las Tarjetas
    contenedor.innerHTML = encontrados.map(j => {
        const posicion = rankeados.findIndex(x => x.id === j.id) + 1;
        const datosEquipo = db.equipos.find(e => e.nombre === j.equipo);
        const logoEquipo = datosEquipo ? datosEquipo.logo : '';
        const fotoPj = j.foto ? j.foto : 'https://via.placeholder.com/60?text=üë§';

        return `
        <div style="background:white; padding:15px; border-radius:12px; margin-bottom:12px; border:1px solid #e2e8f0; display:flex; align-items:center; gap:12px; box-shadow:0 4px 6px -1px rgba(0,0,0,0.1);">
            
            <div style="background:${posicion === 1 ? '#fbbf24' : (posicion <= 3 ? '#94a3b8' : '#64748b')}; color:white; width:35px; height:35px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:14px; flex-shrink:0;">
                #${posicion}
            </div>
            
            <img src="${logoEquipo}" onerror="this.src='https://via.placeholder.com/40?text=üõ°Ô∏è'" 
                 style="width:40px; height:40px; object-fit:contain; border-radius:6px; background:#f8fafc; border:1px solid #eee; flex-shrink:0;">

            <div style="flex:1;">
                <div style="font-weight:bold; color:#1e293b; font-size:14px; text-transform:uppercase;">${j.nombre}</div>
                <div style="color:var(--accent); font-weight:bold; font-size:11px; margin-bottom:4px;">${j.equipo}</div>
                
                <div style="display:flex; gap:5px;">
                    <span style="background:#f1f5f9; padding:2px 6px; border-radius:4px; font-size:10px; color:#475569;">üèüÔ∏è ${j.pj}</span>
                    <span style="background:#dcfce7; padding:2px 6px; border-radius:4px; font-size:10px; color:#166534; font-weight:bold;">‚öΩ ${j.goles}</span>
                    <span style="background:#fef9c3; padding:2px 6px; border-radius:4px; font-size:10px; color:#854d0e;">üü® ${j.ama}</span>
                    <span style="background:#fee2e2; padding:2px 6px; border-radius:4px; font-size:10px; color:#991b1b;">üü• ${j.roja}</span>
                </div>
            </div>

            <div style="flex-shrink:0;">
                <img src="${fotoPj}" 
                     style="width:55px; height:55px; border-radius:50%; object-fit:cover; border:2px solid #3b82f6; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            </div>

        </div>`;
    }).join('');
}
  
function calcularRating(j) {
    if (j.pj === 0) return 0;
    
    // Puntos base por goles (pesan un 60%)
    let puntosGoles = (j.goles / j.pj) * 70;
    
    // Puntos por regularidad (pesan un 30%)
    let puntosPJ = Math.min(j.pj * 5, 30);
    
    // Penalizaci√≥n por disciplina
    let penalizacion = (j.ama * 2) + (j.roja * 10);
    
    let total = puntosGoles + puntosPJ - penalizacion;
    
    // Ajustar entre 0 y 100
    return Math.max(0, Math.min(100, Math.round(total)));
	}


function obtenerJugadoresRankeados() {
    // 1. Clonamos y calculamos puntos para cada uno
    let lista = db.jugadores.map(j => {
        const puntos = (j.goles * 10) + (j.pj * 2) - (j.ama * 3) - (j.roja * 10);
        return { ...j, puntos };
    });

    // 2. Ordenamos de mayor a menor puntuaci√≥n
    lista.sort((a, b) => b.puntos - a.puntos);

    // 3. Asignamos la posici√≥n real (el √≠ndice + 1)
    return lista.map((j, index) => ({ ...j, posicion: index + 1 }));
	}

function reiniciarTodo() {
    // SOLO el Admin puede borrar todo
    if (typeof rolActual !== 'undefined' && rolActual !== "admin") {
        return alert("‚ö†Ô∏è Solo el Administrador puede reiniciar la temporada.");
    }

    // 1. Pedir nombre de la etapa
    let nuevoNombre = prompt("¬øC√≥mo se llamar√° la nueva temporada?\n(Ej: TORNEO 2026)");

    // 2. Validaci√≥n de entrada
    if (nuevoNombre === null || nuevoNombre.trim() === "") {
        alert("Reinicio cancelado. Debes asignar un nombre a la temporada.");
        return;
    }

    nuevoNombre = nuevoNombre.trim().toUpperCase();

    // 3. Confirmaci√≥n final - AJUSTADA para advertir borrado de equipos
    if(confirm(`‚ö†Ô∏è ADVERTENCIA CR√çTICA: Se iniciar√° la temporada: "${nuevoNombre}".\n\nESTO ELIMINAR√Å TODO: Equipos, Jugadores y Partidos.\n\n¬øDeseas continuar?`)) {
        
        db.nombreTemporada = nuevoNombre;

        // --- ELIMINACI√ìN TOTAL ---
        db.equipos = [];    // <--- Esta es la l√≠nea que borra los equipos
        db.jugadores = [];  // Borra jugadores
        db.calendario = []; // Borra partidos
        db.playoffs = {};   // Borra fases finales

        persist(); 
        
        // Es mejor recargar para que todas las tablas se dibujen vac√≠as desde cero
        location.reload(); 
    }
}
document.addEventListener('DOMContentLoaded', () => {
    // 1. Cargar datos y preparar interfaz
    init(); 
    actualizarBanner(); // Pintamos el nombre de la temporada inmediatamente
    
    // 2. Navegar al inicio y marcar el primer bot√≥n como activo
    const btnInicio = document.querySelector('.nav-link');
    navegar('sec-inicio', btnInicio);
    
    // 3. Aplicar permisos (Ocultar/Mostrar botones de Admin)
    aplicarRestricciones();

    // 4. Renderizado diferido (Seguridad para que el DOM est√© listo)
    setTimeout(() => {
        renderTodo();       // Dibuja equipos y tabla
        renderCalendario(); // Pre-carga el calendario en memoria
        console.log("üöÄ Sistema inicializado y renderizado");
    }, 100);
});
// ESCUCHADOR DE EVENTOS PARA LA FOTO
document.addEventListener('change', function(e) {
    // Verificamos que el cambio sea en el input de la foto del jugador
    if (e.target && e.target.id === 'foto-archivo') {
        const archivo = e.target.files[0];
        
        if (archivo) {
            // Validar que sea una imagen
            if (!archivo.type.startsWith('image/')) {
                alert("Por favor, selecciona un archivo de imagen v√°lido.");
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(event) {
                // Guardamos el resultado en la variable global que creaste
                fotoBase64Temp = event.target.result;
                
                // Mostramos la vista previa para confirmar que se carg√≥ bien
                const preview = document.getElementById('previsualizar-foto');
                if (preview) {
                    preview.src = fotoBase64Temp;
                    preview.style.display = "inline-block";
                }
            };

            // Leer el archivo de la PC
            reader.readAsDataURL(archivo);
        }
    }
});
function renderGoleadores() {
    const contenedor = document.getElementById('diseno-goleadores-pro');
    if (!contenedor) return;

    const goleadores = db.jugadores
        .filter(j => (j.goles || 0) > 0)
        .sort((a, b) => b.goles - a.goles)
        .slice(0, 10);

    if (goleadores.length === 0) {
        contenedor.innerHTML = "<p style='text-align:center; padding:50px;'>‚öΩ A√∫n no hay goles registrados.</p>";
        return;
    }

    const mvp = goleadores[0];
    const resto = goleadores.slice(1);
    const eqMvp = db.equipos.find(e => e.nombre === mvp.equipo);
    const promedio = (mvp.goles / (mvp.pj || 1)).toFixed(2);

    contenedor.innerHTML = `
    <div class="contenedor-goleadores-pro">
        <div class="mvp-card" style="background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); padding-bottom: 25px;">
            
            <div class="mvp-photo-wrapper" style="margin-bottom: 10px;">
                <img src="${mvp.foto || 'https://via.placeholder.com/200?text=üë§'}" class="mvp-photo">
                <div class="mvp-number">1¬∫</div>
            </div>

            <div class="mvp-info" style="text-align:center;">
                <h2 style="margin:0; font-size:26px; color:#1e293b;">${mvp.nombre}</h2>
                <div style="color:#4caf50; font-weight:bold; text-transform:uppercase; font-size:15px; margin-top:5px;">${mvp.equipo}</div>
            </div>

            <div style="text-align:center; margin: 20px 0;">
                <img src="${eqMvp?.logo || ''}" style="width:85px; height:85px; object-fit:contain; filter:drop-shadow(0 4px 8px rgba(0,0,0,0.1));" onerror="this.style.display='none'">
            </div>
                
            <div class="mvp-stats-grid" style="display:flex; justify-content:space-around; align-items:center; background:#f8fafc; border-radius:15px; padding:20px; border:1px solid #edf2f7; margin: 0 25px;">
                <div style="display:flex; flex-direction:column; align-items:center; flex:1;">
                    <span style="font-size:30px; margin-bottom:5px;">‚öΩ</span>
                    <strong style="font-size:32px; color:#1e293b;">${mvp.goles}</strong>
                    <small style="font-size:11px; color:#94a3b8; text-transform:uppercase; font-weight:bold;">Goles</small>
                </div>

                <div style="width:1px; height:50px; background:#e2e8f0;"></div>

                <div style="display:flex; flex-direction:column; align-items:center; flex:1;">
                    <span style="font-size:30px; margin-bottom:5px;">üèüÔ∏è</span>
                    <strong style="font-size:32px; color:#1e293b;">${mvp.pj}</strong>
                    <small style="font-size:11px; color:#94a3b8; text-transform:uppercase; font-weight:bold;">Partidos</small>
                </div>
            </div>

            <div style="text-align:center; margin-top: 20px;">
                <div style="display:inline-block; background:#f0fdf4; color:#16a34a; padding:8px 25px; border-radius:50px; font-size:13px; font-weight:800; border:1.5px solid #16a34a;">
                    ‚ö° PROMEDIO: ${promedio} GOLES POR PARTIDO
                </div>
            </div>
        </div>

        <div class="lista-goleadores" style="margin-top:25px;">
            ${resto.map((j, i) => {
                const eq = db.equipos.find(e => e.nombre === j.equipo);
                const background = i % 2 === 0 ? '#ffffff' : '#f8fafc'; 
                return `
                <div class="item-goleador" style="display:flex; align-items:center; padding:12px 15px; background:${background}; border-radius:12px; margin-bottom:8px; border:1px solid #edf2f7;">
                    <div class="rank" style="width:35px; font-weight:800; color:#1e293b; font-size:15px;">${i + 2}¬∫</div>
                    <img src="${j.foto || 'https://via.placeholder.com/40?text=üë§'}" class="img-pj" style="width:48px; height:48px; border-radius:12px; border:2px solid #fff; box-shadow:0 2px 4px rgba(0,0,0,0.1); object-fit:cover; margin: 0 12px;">
                    <div class="name-pj" style="flex:1;">
                        <strong style="font-size:15px; color:#0f172a; display:block;">${j.nombre}</strong>
                        <span style="font-size:12px; color:#64748b; font-weight:600; text-transform:uppercase;">${j.equipo}</span>
                    </div>
                    <img src="${eq?.logo || ''}" class="img-eq" style="width:30px; height:30px; object-fit:contain; margin-right:15px;">
                    <div style="display:flex; gap:12px; align-items:center; background:#f1f5f9; padding:6px 14px; border-radius:10px;">
                        <div style="display:flex; align-items:center; gap:5px;">
                            <span style="font-size:16px;">‚öΩ</span>
                            <div style="font-weight:900; color:#16a34a; font-size:20px;">${j.goles}</div>
                        </div>
                        <div style="width:1px; height:20px; background:#cbd5e1;"></div>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <span style="font-size:16px;">üèüÔ∏è</span>
                            <div style="font-weight:700; color:#475569; font-size:16px;">${j.pj}</div>
                        </div>
                    </div>
                </div>`;
            }).join('')}
        </div>
    </div>`;
}
function prepararComparador() {
    const s1 = document.getElementById('select-j1');
    const s2 = document.getElementById('select-j2');
    
    if (!s1 || !s2) {
        console.error("No se encontraron los selectores del comparador");
        return; 
    }

    // 1. Verificamos que db y db.jugadores existan antes de ordenar
    const listaJugadores = (window.db && db.jugadores) ? db.jugadores : [];
    
    // 2. Ordenamos
    const jugadoresOrdenados = [...listaJugadores].sort((a,b) => a.nombre.localeCompare(b.nombre));
    
    // 3. Creamos las opciones
    let htmlOptions = '<option value="">Selecciona un jugador...</option>';
    
    if (jugadoresOrdenados.length > 0) {
        htmlOptions += jugadoresOrdenados.map(j => 
            `<option value="${j.nombre}">${j.nombre} (${j.equipo || 'Sin Equipo'})</option>`
        ).join('');
    } else {
        htmlOptions = '<option value="">No hay jugadores registrados</option>';
    }
    
    // 4. Llenamos los selects
    s1.innerHTML = htmlOptions;
    s2.innerHTML = htmlOptions;
    
    // 5. SEGURO: Verificamos la longitud de las opciones para evitar el error de 'length'
    const totalOptions = s1.options ? s1.options.length : 0;

    if (totalOptions > 1) {
        s1.selectedIndex = 1;
        // Solo intentamos el √≠ndice 2 si realmente hay suficientes jugadores
        if (totalOptions > 2) {
            s2.selectedIndex = 2;
        } else {
            s2.selectedIndex = 1;
        }
    }
    
    // 6. Ejecutamos la comparaci√≥n inicial
    if (typeof compararJugadores === 'function') {
        compararJugadores();
    }
}

function compararJugadores() {
    const id1 = document.getElementById('select-j1').value;
    const id2 = document.getElementById('select-j2').value;
    const res = document.getElementById('render-comparativa');

    if (!res) return;

    const j1 = db.jugadores.find(j => String(j.id) === String(id1));
    const j2 = db.jugadores.find(j => String(j.id) === String(id2));

    if (!j1 && !j2) {
        res.innerHTML = `<div style="text-align:center; padding:50px; color:#94a3b8; border:2px dashed #334155; border-radius:20px; margin-top:20px;">
            <p>üîç Busca un jugador para generar su carta...</p>
        </div>`;
        return;
    }

    // Calculamos posiciones para el brillo
    const listaOrdenada = [...db.jugadores].sort((a, b) => (b.goles || 0) - (a.goles || 0));
    const pos1 = j1 ? listaOrdenada.findIndex(p => String(p.id) === String(j1.id)) + 1 : 999;
    const pos2 = j2 ? listaOrdenada.findIndex(p => String(p.id) === String(j2.id)) + 1 : 999;

   res.innerHTML = `
    <div class="fc-comparison-wrapper animate__animated animate__fadeIn">
        
        <div class="fc-card ${j1 ? 'gold-theme' : 'empty-slot'} ${j1 && j2 && pos1 < pos2 ? 'fc-glow' : ''}">
            ${j1 ? renderContenidoCarta(j1, 1) : '<div class="fc-placeholder">ESPERANDO JUGADOR...</div>'}
        </div>

        <div class="fc-stats-panel">
            <div class="vs-badge">VS</div>
            ${j1 && j2 ? `
                ${renderFilaStat("GOLES", j1.goles, j2.goles, "‚öΩ")}
                ${renderFilaStat("PARTIDOS", j1.pj, j2.pj, "üèüÔ∏è")}
                ${renderFilaStat("AMARILLAS", j1.ama, j2.ama, "üü®")}
                ${renderFilaStat("ROJAS", j1.roja, j2.roja, "üü•")}
            ` : `<div style="text-align:center; opacity:0.4; font-size:11px;">
                    SELECCIONA OTRO JUGADOR <br> PARA COMPARAR STATS
                 </div>`}
        </div>

        <div class="fc-card ${j2 ? 'gold-theme' : 'empty-slot'} ${j1 && j2 && pos2 < pos1 ? 'fc-glow' : ''}">
            ${j2 ? renderContenidoCarta(j2, 2) : '<div class="fc-placeholder">ESPERANDO RIVAL...</div>'}
        </div>

    </div>`;
}
// Funci√≥n para no repetir c√≥digo de la carta
function renderContenidoCarta(j, slot) {
    const eq = db.equipos.find(e => e.nombre === j.equipo);
    
    const posicionReal = [...db.jugadores]
        .sort((a, b) => (b.goles || 0) - (a.goles || 0))
        .findIndex(p => String(p.id) === String(j.id)) + 1;

    return `
    <div class="fc-card-inner">
        <button class="fc-delete-btn" onclick="quitarSlot(${slot})">√ó</button>

        <div class="fc-rating-side">
            <div class="fc-overall">${posicionReal}</div>
            <div class="fc-pos-label">RANK</div>
            <img src="${eq?.logo || ''}" class="fc-team-badge-small">
        </div>
        <div class="fc-photo-container">
            <img src="${j.foto || 'https://via.placeholder.com/150'}" class="fc-player-photo">
        </div>
        <div class="fc-info">
            <div class="fc-name">${j.nombre}</div>
            <div class="fc-team-name">${j.equipo}</div>
        </div>
    </div>`;
}
function renderFilaStat(label, v1, v2, icon) {
    const n1 = parseFloat(v1) || 0;
    const n2 = parseFloat(v2) || 0;
    const total = n1 + n2 || 1;
    const p1 = (n1 / total) * 100;
    const p2 = (n2 / total) * 100;

    return `
    <div class="fc-stat-row">
        <div class="fc-stat-labels">
            <span class="${n1 > n2 ? 'winner-text' : ''}">${n1}</span>
            <span class="fc-stat-name">${icon} ${label}</span>
            <span class="${n2 > n1 ? 'winner-text' : ''}">${n2}</span>
        </div>
        <div class="fc-bar-bg">
            <div class="fc-bar-fill left" style="width: ${p1}%"></div>
            <div class="fc-bar-fill right" style="width: ${p2}%"></div>
        </div>
    </div>`;
}
function renderCardComparador(j, prom, colorBase, esGanador, puesto, titulo, numSlot) {
    const shadow = esGanador ? '0 0 35px rgba(245, 158, 11, 0.3)' : '0 10px 25px rgba(0,0,0,0.08)';
    const headerBg = esGanador ? 'linear-gradient(135deg, #f59e0b 0%, #b45309 100%)' : `linear-gradient(135deg, ${colorBase} 0%, #1e293b 100%)`;

    return `
    <div class="animar-entrada" style="flex: 1; min-width: 280px; max-width: 360px; background: white; border-radius: 25px; overflow: hidden; box-shadow: ${shadow}; position: relative; border: ${esGanador ? '3px solid #f59e0b' : '1px solid #e2e8f0'};">
        
        <div onclick="quitarSoloUno(${numSlot})" 
             style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; z-index: 100;">
            √ó
        </div>
        
        <div style="background: ${headerBg}; padding: 20px 15px; text-align: center; color: white;">
            <div style="font-size: 24px; font-weight: 950; text-transform: uppercase; letter-spacing: -1px;">${j.nombre}</div>
            <div style="margin-top: 5px; background: rgba(0,0,0,0.2); display: inline-block; padding: 2px 12px; border-radius: 20px; font-size: 11px; font-weight: 800; letter-spacing: 1px;">
                RANKING #${puesto}
            </div>
        </div>
        
        <div style="padding: 20px; text-align: center;">
            <img src="${j.foto || 'https://via.placeholder.com/120?text=üë§'}" style="width: 120px; height: 120px; border-radius: 20px; object-fit: cover; border: 4px solid #f1f5f9; margin-bottom: 15px;">
            
            <div style="background: #f8fafc; padding: 15px; border-radius: 20px; border: 1px solid #f1f5f9; margin-bottom: 15px;">
                <div style="font-size: 45px; font-weight: 900; color: #0f172a; line-height: 1;">${j.goles}</div>
                <div style="font-size: 10px; color: #64748b; text-transform: uppercase; font-weight: 700;">Goles Anotados</div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                <div style="background: #f1f5f9; padding: 10px; border-radius: 12px;">
                    <small style="font-size: 9px; color: #94a3b8; font-weight: 800;">PARTIDOS</small><br>
                    <b style="font-size: 18px; color: #1e293b;">${j.pj}</b>
                </div>
                <div style="background: #f1f5f9; padding: 10px; border-radius: 12px;">
                    <small style="font-size: 9px; color: #94a3b8; font-weight: 800;">PROMEDIO</small><br>
                    <b style="font-size: 18px; color: #1e293b;">${prom}</b>
                </div>
            </div>

            <div style="display: flex; gap: 8px; margin-top: 15px;">
                <div style="flex: 1; background: #fffbeb; color: #b45309; border: 1px solid #fde68a; padding: 6px; border-radius: 8px; font-weight: 900; font-size: 12px;">üü® ${j.ama}</div>
                <div style="flex: 1; background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; padding: 6px; border-radius: 8px; font-weight: 900; font-size: 12px;">üü• ${j.roja}</div>
            </div>
        </div>
    </div>`;
}

// ... aqu√≠ terminan tus otras funciones (como guardarEquipo, generarCalendario, etc.) ...

    // PASO 3: FUNCI√ìN DEL BUSCADOR
    function renderMiCalendario() {
        const contenedor = document.getElementById('render-mi-calendario');
        const filtro = document.getElementById('busqueda-usuario').value.toLowerCase();
        
        if (filtro === "") {
            contenedor.innerHTML = "<p style='text-align:center; color:#64748b;'>Escribe el nombre de tu equipo para ver sus partidos.</p>";
            return;
        }

        let html = "";
        // Recorremos el calendario oficial
        db.calendario.forEach(jornada => {
            const partidosEncontrados = jornada.partidos.filter(p => 
                p.l.toLowerCase().includes(filtro) || p.v.toLowerCase().includes(filtro)
            );

            if (partidosEncontrados.length > 0) {
                html += `
                    <div style="margin-bottom:15px; border:1px solid #eee; border-radius:8px; overflow:hidden;">
                        <div style="background:#1e293b; color:white; padding:8px 15px; font-weight:bold; font-size:13px;">
                            JORNADA ${jornada.num}
                        </div>
                `;
                partidosEncontrados.forEach(p => {
                    html += `
                        <div style="display:flex; justify-content:space-between; padding:12px; background:white; align-items:center;">
                            <span style="flex:1; text-align:right; font-weight:bold; font-size:14px;">${p.l}</span>
                            <span style="flex:0.3; text-align:center; color:#3b82f6; font-weight:bold;">${p.score || 'vs'}</span>
                            <span style="flex:1; text-align:left; font-weight:bold; font-size:14px;">${p.v}</span>
                        </div>
                    `;
                });
                html += `</div>`;
            }
        });

        contenedor.innerHTML = html || `<p style='text-align:center; padding:20px;'>No se encontraron partidos para "${filtro}".</p>`;
    }

function resolverDefault(idPartido) {
    let partido;
    db.calendario.forEach(j => {
        let x = j.partidos.find(p => p.id === idPartido);
        if (x) partido = x;
    });

    if (!partido) return;

    // 1. Pedir ganador
    const opcion = prompt(`RESOLVER POR DEFAULT (W.O.)\n\n1. Gan√≥ Local (${partido.l})\n2. Gan√≥ Visita (${partido.v})\n\nEscribe 1 o 2:`);

    if (opcion !== "1" && opcion !== "2") {
        alert("Operaci√≥n cancelada.");
        return;
    }

    // 2. Pedir el motivo
    const motivo = prompt("Escribe el motivo del Default (ej. El equipo no se present√≥):") || "No se presentaron";

    const gL = (opcion === "1") ? 3 : 0;
    const gV = (opcion === "2") ? 3 : 0;

    // 3. Actualizar estado del partido
    partido.score = `${gL} - ${gV}`;
    partido.jugado = true;

    // --- DISE√ëO VISUAL PARA EL REPORTE ---
    const cajaMotivo = `
        <div style="margin-top: 15px; padding: 15px; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 8px; text-align: center;">
            <div style="color: #475569; font-weight: bold; font-size: 14px; margin-bottom: 5px; text-transform: uppercase;">
                üö´ Incomparecencia (W.O.)
            </div>
            <div style="color: #1e293b; font-size: 16px; font-weight: 600; font-style: italic;">
                "${motivo}"
            </div>
        </div>
    `;

    partido.reporteHtml = {
        local: gL > gV ? 
            `<b style='color:#10b981; font-size:18px;'>GAN√ì POR DEFAULT (3-0)</b>${cajaMotivo}` : 
            `<b style='color:#ef4444; font-size:18px;'>PERDI√ì POR DEFAULT (0-3)</b>`,
        visita: gV > gL ? 
            `<b style='color:#10b981; font-size:18px;'>GAN√ì POR DEFAULT (3-0)</b>${cajaMotivo}` : 
            `<b style='color:#ef4444; font-size:18px;'>PERDI√ì POR DEFAULT (0-3)</b>`
    };

    // 4. Actualizar tabla de posiciones
    const eqL = db.equipos.find(e => e.nombre === partido.l);
    const eqV = db.equipos.find(e => e.nombre === partido.v);

    if (eqL && eqV) {
        eqL.pj++; eqV.pj++;
        eqL.gf += gL; eqL.gc += gV;
        eqV.gf += gV; eqV.gc += gL;

        if (gL > gV) {
            eqL.g++; eqL.pts += 3; eqV.p++;
        } else {
            eqV.g++; eqV.pts += 3; eqL.p++;
        }
    }

    persist();    
    renderTodo(); 
    alert("Partido resuelto por default con reporte visual.");
}

function resolverProtesta(idPartido) {
    if(!confirm("¬°ATENCI√ìN! Se eliminar√°n los goles de los jugadores del Pichichi y el marcador cambiar√° a 3-0. ¬øContinuar?")) return;

    let partido;
    db.calendario.forEach(j => {
        let x = j.partidos.find(p => p.id === idPartido);
        if (x) partido = x;
    });

    // --- 1. LIMPIEZA DE JUGADORES (Analizando tu HTML) ---
    const tempDiv = document.createElement('div');
    const reportes = [partido.reporteHtml.local, partido.reporteHtml.visita];
    
    reportes.forEach(html => {
        if (!html) return;
        tempDiv.innerHTML = html;
        const lineas = tempDiv.querySelectorAll('div'); 
        lineas.forEach(linea => {
            const texto = linea.innerText; 
            if (texto.includes('‚öΩx')) {
                const partes = texto.split('‚öΩx');
                const nombreJugador = partes[0].replace('‚Ä¢', '').trim();
                const golesARestar = parseInt(partes[1]);
                const j = db.jugadores.find(x => x.nombre === nombreJugador);
                if (j) {
                    j.goles = Math.max(0, (j.goles || 0) - golesARestar);
                    j.pj = Math.max(0, (j.pj || 0) - 1);
                }
            }
        });
    });

    // --- 2. REVERTIR PUNTOS DE EQUIPOS ---
    const eqL = db.equipos.find(e => e.nombre === partido.l);
    const eqV = db.equipos.find(e => e.nombre === partido.v);
    const sAnt = partido.score.split('-').map(s => parseInt(s.trim()) || 0);

    eqL.pj--; eqV.pj--;
    eqL.gf -= sAnt[0]; eqL.gc -= sAnt[1];
    eqV.gf -= sAnt[1]; eqV.gc -= sAnt[0];

    if(sAnt[0] > sAnt[1]) { eqL.g--; eqL.pts -= 3; eqV.p--; }
    else if(sAnt[1] > sAnt[0]) { eqV.g--; eqV.pts -= 3; eqL.p--; }
    else { eqL.e--; eqV.e--; eqL.pts -= 1; eqV.pts -= 1; }

    // --- 3. NUEVO RESULTADO Y MOTIVO (ESTILO VISUAL IMPACTANTE) ---
    const res = prompt(`¬øQui√©n gana la protesta?\n1. ${partido.l}\n2. ${partido.v}`);
    if (res !== "1" && res !== "2") return alert("Cancelado.");

    const motivo = prompt("Escribe el motivo de la protesta:") || "No especificado";

    const gL_n = (res === "1") ? 3 : 0;
    const gV_n = (res === "2") ? 3 : 0;

    partido.score = `${gL_n} - ${gV_n}`;

    // Dise√±o visual para el reporte
    const cajaMotivo = `
        <div style="margin-top: 15px; padding: 15px; background: #fffbeb; border: 1px solid #fef3c7; border-radius: 8px; text-align: center;">
            <div style="color: #b45309; font-weight: bold; font-size: 14px; margin-bottom: 5px; text-transform: uppercase;">
                ‚ö†Ô∏è Resoluci√≥n de Mesa
            </div>
            <div style="color: #78350f; font-size: 16px; font-weight: 600; font-style: italic;">
                "${motivo}"
            </div>
        </div>
    `;

    partido.reporteHtml = { 
        local: gL_n === 3 ? 
            `<b style='color:#10b981; font-size:18px;'>GAN√ì PROTESTA (3-0)</b>${cajaMotivo}` : 
            `<b style='color:#ef4444; font-size:18px;'>PERDI√ì PROTESTA (0-3)</b>`, 
        visita: gV_n === 3 ? 
            `<b style='color:#10b981; font-size:18px;'>GAN√ì PROTESTA (3-0)</b>${cajaMotivo}` : 
            `<b style='color:#ef4444; font-size:18px;'>PERDI√ì PROTESTA (0-3)</b>` 
    };

    // --- 4. SUMAR NUEVOS PUNTOS ---
    eqL.pj++; eqV.pj++;
    eqL.gf += gL_n; eqL.gc += gV_n;
    eqV.gf += gV_n; eqV.gc += gL_n;
    if(gL_n > gV_n) { eqL.g++; eqL.pts += 3; eqV.p++; }
    else { eqV.g++; eqV.pts += 3; eqL.p++; }

    persist();
    renderTodo();
    alert("Protesta aplicada correctamente.");
}

function resetearPartido(idPartido) {
    if(!confirm("¬øEST√ÅS SEGURO? Se borrar√°n goles, tarjetas, se restar√°n los puntos y el partido volver√° a estar pendiente.")) return;

    let partido;
    db.calendario.forEach(j => {
        let x = j.partidos.find(p => p.id === idPartido);
        if (x) partido = x;
    });

    if (!partido || !partido.jugado) return;

    const tempDiv = document.createElement('div');
    const reportes = [partido.reporteHtml.local, partido.reporteHtml.visita];
    
    reportes.forEach(html => {
        if (!html) return;
        tempDiv.innerHTML = html;
        
        // Buscamos todas las l√≠neas de incidencia
        const lineas = tempDiv.querySelectorAll('div'); 
        
        lineas.forEach(linea => {
            const texto = linea.innerText;
            // Extraer nombre del jugador
            const nombreJugador = texto.split(/[‚öΩüü®üü•]/)[0].replace('‚Ä¢', '').trim();
            const j = db.jugadores.find(x => x.nombre === nombreJugador);

            if (j) {
                // 1. RESTRAR GOLES
                if (linea.innerHTML.includes('‚öΩ')) {
                    let cant = 1;
                    if (texto.includes('‚öΩx')) cant = parseInt(texto.split('‚öΩx')[1]) || 1;
                    j.goles = Math.max(0, (j.goles || 0) - cant);
                }

                // 2. LOGICA PARA TARJETAS (Doble Amarilla vs Directas)
                
                // DETECCI√ìN CR√çTICA: ¬øTiene la clase de Doble Amarilla de CSS o los emojis pegados?
                const tieneDobleA_CSS = linea.querySelector('.doble-tarjeta-container') !== null;
                const tieneDobleA_Emoji = texto.includes('üü®üü•');

                if (tieneDobleA_CSS || tieneDobleA_Emoji) {
                    // Si fue doble amarilla, restamos 1 ROJA √∫nicamente 
                    // (porque al guardar pusimos 0 amarillas y 1 roja)
                    j.roja = Math.max(0, (j.roja || 0) - 1);
                } else {
                    // Si no es doble amarilla, restamos por separado
                    if (texto.includes('üü®')) {
                        let cant = 1;
                        if (texto.includes('üü®x')) cant = parseInt(texto.split('üü®x')[1]) || 1;
                        j.ama = Math.max(0, (j.ama || 0) - cant);
                    }
                    if (texto.includes('üü•')) {
                        let cant = 1;
                        if (texto.includes('üü•x')) cant = parseInt(texto.split('üü•x')[1]) || 1;
                        j.roja = Math.max(0, (j.roja || 0) - 1);
                    }
                }
                
                j.pj = Math.max(0, (j.pj || 0) - 1);
            }
        });
    });

    // --- REVERSI√ìN DE EQUIPOS (Tu c√≥digo que ya funciona) ---
    const eqL = db.equipos.find(e => e.nombre === partido.l);
    const eqV = db.equipos.find(e => e.nombre === partido.v);
    const sAnt = partido.score.split('-').map(s => parseInt(s.trim()) || 0);

    eqL.pj--; eqV.pj--;
    eqL.gf -= sAnt[0]; eqL.gc -= sAnt[1];
    eqV.gf -= sAnt[1]; eqV.gc -= sAnt[0];

    if(sAnt[0] > sAnt[1]) { eqL.g--; eqL.pts -= 3; eqV.p--; }
    else if(sAnt[1] > sAnt[0]) { eqV.g--; eqV.pts -= 3; eqL.p--; }
    else { eqL.e--; eqV.e--; eqL.pts -= 1; eqV.pts -= 1; }

    partido.score = "0 - 0";
    partido.jugado = false;
    partido.reporteHtml = null;

    persist();
    renderTodo();
    alert("‚úÖ Reseteo completo: Se elimin√≥ la Roja por doble amarilla de las estad√≠sticas.");
}
function filtrarBusquedaUnica() {
    const input = document.getElementById('main-search');
    const divResultados = document.getElementById('main-results');
    if (!input || !divResultados) return; // Validaci√≥n de seguridad
    const texto = input.value.toLowerCase().trim();

    if (texto.length < 1) {
        divResultados.style.display = 'none';
        return;
    }

    const coincidencias = db.jugadores.filter(j => 
        j.nombre.toLowerCase().includes(texto) || j.equipo.toLowerCase().includes(texto)
    );

    if (coincidencias.length === 0) {
        divResultados.innerHTML = `<div style="padding:15px; color:#94a3b8;">No se encontraron jugadores</div>`;
    } else {
       // DENTRO DE filtrarBusquedaUnica, cambia el map por este:
divResultados.innerHTML = coincidencias.map(j => `
    <div onmousedown="asignarAlDuelo(${j.id})" 
         style="padding:12px 15px; border-bottom:1px solid #f1f5f9; cursor:pointer; display:flex; align-items:center; gap:12px;"
         class="resultado-item">
        <img src="${j.foto || 'https://via.placeholder.com/40'}" style="width:40px; height:40px; border-radius:8px; object-fit:cover;">
        <div style="flex:1">
            <div style="font-weight:900; color:#1e293b; font-size:14px;">${j.nombre}</div>
            <div style="font-size:11px; color:#3b82f6; font-weight:700;">${j.equipo}</div>
        </div>
    </div>
`).join('');
    }

    divResultados.style.display = 'block';
}

function asignarAlDuelo(id) {
    // Convertimos a String para evitar errores de comparaci√≥n (1 vs "1")
    const idStr = String(id);
    const s1 = document.getElementById('select-j1');
    const s2 = document.getElementById('select-j2');

    // 1. Validar si el jugador ya est√° seleccionado
    if (idStr === s1.value || idStr === s2.value) {
        alert("¬°Este jugador ya est√° en el duelo!");
        return;
    }

    // 2. Buscar jugador en la base de datos
    const jugador = db.jugadores.find(j => String(j.id) === idStr);
    if (!jugador) {
        console.error("Jugador no encontrado con ID:", id);
        return;
    }

    const slot1 = document.getElementById('slot-1');
    const slot2 = document.getElementById('slot-2');

    // 3. Asignaci√≥n inteligente con actualizaci√≥n de valor
    if (proximoSlot === 1) {
        s1.value = idStr; // Guardamos el ID en el input oculto
        if(slot1) slot1.innerHTML = `<b style="color:#3b82f6">üîµ ${jugador.nombre}</b>`;
        proximoSlot = s2.value === "" ? 2 : 1;
    } else {
        s2.value = idStr; // Guardamos el ID en el input oculto
        if(slot2) slot2.innerHTML = `<b style="color:#ef4444">üî¥ ${jugador.nombre}</b>`;
        proximoSlot = s1.value === "" ? 1 : 2;
    }

    // 4. Limpieza de resultados
    document.getElementById('main-search').value = "";
    document.getElementById('main-results').style.display = 'none';

    // 5. IMPORTANTE: Llamar a compararJugadores para que dibuje las fotos
    if (typeof compararJugadores === 'function') {
        compararJugadores();
    }
}
function limpiarDuelo() {
    document.getElementById('select-j1').value = "";
    document.getElementById('select-j2').value = "";
    document.getElementById('render-comparativa').innerHTML = "";
    
    // Resetear slots visuales si existen
    if(document.getElementById('slot-1')) document.getElementById('slot-1').innerHTML = "ESPERANDO JUGADOR 1...";
    if(document.getElementById('slot-2')) document.getElementById('slot-2').innerHTML = "ESPERANDO JUGADOR 2...";
    
    proximoSlot = 1;
}
function quitarSlot(num) {
    // 1. Borramos el ID del input oculto
    document.getElementById(`select-j${num}`).value = "";
    
    // 2. Si tienes etiquetas de texto externas (opcional), las limpias
    const slotLabel = document.getElementById(`slot-${num}`);
    if (slotLabel) slotLabel.innerHTML = `Slot ${num}`;

    // 3. Importante: Cambiamos el turno para que la pr√≥xima b√∫squeda llene este slot
    proximoSlot = num;

    // 4. Refrescamos la vista
    compararJugadores();
}
function quitarSoloUno(num) {
    // 1. Limpiamos el ID en el input oculto
    document.getElementById('select-j' + num).value = "";
    
    // 2. Sincronizamos la variable global para que el buscador use este slot
    proximoSlot = num; 

    // 3. Limpiamos el texto de ayuda si lo usas
    const slotVisual = document.getElementById('slot-' + num);
    if(slotVisual) slotVisual.innerHTML = "ESPERANDO JUGADOR " + num + "...";

    // 4. Volvemos a renderizar la comparativa
    compararJugadores();
}

function init() {
    // Usamos el mismo nombre que en persist() para que coincidan
    const NOMBRE_DB = 'LIGA_PRO_FINAL'; 
    const datosGuardados = localStorage.getItem(NOMBRE_DB);
    
    try {
        if (datosGuardados) {
            window.db = JSON.parse(datosGuardados);
            // Si por alguna raz√≥n faltan los arrays b√°sicos, los reponemos
            if (!window.db.equipos) window.db.equipos = [];
            if (!window.db.jugadores) window.db.jugadores = [];
            if (!window.db.calendario) window.db.calendario = [];
        } else {
            // Estructura inicial limpia
            window.db = {
                jugadores: [],
                equipos: [],
                calendario: [],
                playoffs: {},
                nombreTemporada: "LIGA PRO ELITE 2026"
            };
        }
    } catch (e) {
        console.error("Error cargando base de datos, iniciando limpia:", e);
        window.db = { jugadores: [], equipos: [], calendario: [], nombreTemporada: "Nueva Temporada" };
    }
}

// --- GESTI√ìN DE TEMPORADA ---
function actualizarBanner() {
    const tituloBanner = document.getElementById('banner-titulo');
    const temporadaBanner = document.getElementById('banner-temporada');

    if (tituloBanner) {
        // LEER DIRECTO DE LA DB PARA QUE SEA DIN√ÅMICO
        const nombreParaMostrar = db.nombreTorneoActual || "Torneo";
        const palabras = nombreParaMostrar.split(" ");
        
        if (palabras.length > 1) {
            const ultima = palabras.pop();
            tituloBanner.innerHTML = `${palabras.join(" ")} <span style="color: var(--accent);">${ultima}</span>`;
        } else {
            tituloBanner.innerText = nombreParaMostrar;
        }
    }

    if (temporadaBanner) {
        temporadaBanner.innerText = db.nombreTemporada || "2026";
    }
}
function renderEquipos() {
    const grid = document.getElementById('grid-equipos');
    if (!grid) return;
    grid.innerHTML = ""; // Limpieza del contenedor

    // Solo recorremos los equipos reales que est√°n en la base de datos
    db.equipos.forEach((eq, index) => {
        if (!eq.nombre) return; 

        const card = document.createElement('div');
        card.className = "equipo-card";
        
        // Al hacer clic en la tarjeta, vemos la plantilla del equipo
        card.onclick = () => verPlantilla(eq.nombre);
        
        const logoHTML = eq.logo 
            ? `<img src="${eq.logo}" class="img-logo" style="width:60px; height:60px; object-fit:cover; border-radius:8px;">`
            : `<div style="width:60px; height:60px; background:#e2e8f0; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:30px; margin: 0 auto 10px;">üõ°Ô∏è</div>`;
        
        card.innerHTML = `
            ${logoHTML}
            <div style="font-weight:bold">${eq.nombre}</div>
            ${(rolActual === 'admin' || rolActual === 'editor') ? `
                <div class="admin-only" style="margin-top:10px; display:flex; gap:5px; justify-content:center;">
                    <button class="btn-del" style="padding:4px 8px;" onclick="event.stopPropagation(); prepararEdicionEquipo(${index})">‚úèÔ∏è</button>
                    <button class="btn-del" style="padding:4px 8px;" onclick="event.stopPropagation(); borrarEquipo(${index})">üóëÔ∏è</button>
                </div>` : ''}
        `;
        grid.appendChild(card);
    });
}

// Funci√≥n auxiliar para no ensuciar el render
function ejecutarRegistroEquipo(nombre) {
    const nuevo = {
        id: Date.now(),
        nombre: nombre,
        logo: "",
        pj: 0, g: 0, e: 0, p: 0, gf: 0, gc: 0, pts: 0
    };
    db.equipos.push(nuevo);
    persist();
    renderEquipos(); 
}

function eliminarPj(id, nombreEquipo) {
    if (!modoAdmin) return alert("Acci√≥n bloqueada: Requiere permisos de Administrador.");

    // 1. Buscar al jugador para confirmar por nombre
    const jugador = db.jugadores.find(j => String(j.id) === String(id));
    
    if (!jugador) {
        alert("Error: No se encontr√≥ al jugador.");
        return;
    }

    // 2. Confirmaci√≥n con el usuario
    if (confirm(`¬øEst√°s seguro de eliminar a "${jugador.nombre}" de la base de datos?\nEsta acci√≥n borrar√° todas sus estad√≠sticas.`)) {
        
        // 3. Filtrar el array (Dejar a todos menos al eliminado)
        db.jugadores = db.jugadores.filter(j => String(j.id) !== String(id));

        // 4. Guardar cambios permanentemente
        persist();

        // 5. Refrescar la vista actual
        verPlantilla(nombreEquipo);
        
        // 6. Opcional: Refrescar tablas generales por si estaba en el Pichichi
        if (typeof renderTodo === 'function') renderTodo();

        alert("Jugador eliminado con √©xito.");
    }
}

function procesarFoto(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.src = e.target.result;
        
        img.onload = function() {
            // --- INICIO DE COMPRESI√ìN ---
            const canvas = document.createElement('canvas');
            const MAX_WIDTH = 200; // Suficiente para una miniatura de jugador
            const scaleSize = MAX_WIDTH / img.width;
            canvas.width = MAX_WIDTH;
            canvas.height = img.height * scaleSize;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            // Convertimos a JPEG con calidad baja (0.6) para ahorrar espacio
            const fotoData = canvas.toDataURL('image/jpeg', 0.6);
            // --- FIN DE COMPRESI√ìN ---

            fotoBase64Temp = fotoData;

            const idEditando = document.getElementById('edit-pj-id').value;
            if (idEditando !== "-1") {
                const index = db.jugadores.findIndex(j => String(j.id) === String(idEditando));
                if (index !== -1) {
                    db.jugadores[index].foto = fotoData;
                    persist();
                    
                    const equipoActual = document.getElementById('tit-equipo').innerText.trim();
                    verPlantilla(equipoActual);
                    alert("‚úÖ Foto optimizada y guardada");
                }
            } else {
                // Previsualizaci√≥n para nuevo jugador
                const preview = document.getElementById('previsualizar-foto');
                if (preview) {
                    preview.src = fotoData;
                    preview.style.display = "block";
                }
            }
        };
    };
    reader.readAsDataURL(file);
}
function limpiarFormularioJugador() {
    document.getElementById('pj-nombre').value = "";
    document.getElementById('pj-curp').value = "";
    document.getElementById('edit-pj-id').value = "-1";
    document.getElementById('foto-archivo').value = "";
    document.getElementById('previsualizar-foto').style.display = "none";
    document.getElementById('placeholder-foto').style.display = "block";
    fotoBase64Temp = "";
}

function aplicarPermisosVisuales() {
    // Si modoAdmin es true, mostramos todo lo que sea admin-only
    const displayStyle = modoAdmin ? 'block' : 'none';
    const displayTable = modoAdmin ? 'table-cell' : 'none';

    document.querySelectorAll('.admin-only').forEach(el => {
        // Si es un elemento de tabla (TD o TH) usamos table-cell, si no block
        if (el.tagName === 'TD' || el.tagName === 'TH') {
            el.style.setProperty('display', displayTable, 'important');
        } else {
            el.style.setProperty('display', displayStyle, 'important');
        }
    });
}

function prepararEdicionEquipo(index) {
    const eq = db.equipos[index];
    if (!eq) return;

    // Llenamos los campos del formulario de equipos
    document.getElementById('eq-nombre').value = eq.nombre;
    document.getElementById('edit-eq-id').value = index; // Usamos el index como referencia
    
    // Cambiamos el texto del bot√≥n para que el usuario sepa que est√° editando
    const btn = document.querySelector('#form-registro-equipo .btn-main');
    if (btn) btn.innerText = "ACTUALIZAR EQUIPO";

    // Opcional: Scroll suave hacia el formulario
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function cancelarEdicionEquipo() {
    document.getElementById('eq-nombre').value = "";
    document.getElementById('edit-eq-id').value = "-1";
    document.getElementById('eq-logo-file').value = "";
    
    // Cambiar el texto del bot√≥n principal
    const btn = document.querySelector('#form-registro-equipo .btn-main');
    if (btn) btn.innerText = "GUARDAR EQUIPO";
    
    // OCULTAR el bot√≥n de cancelar (la X roja)
    const btnCancel = document.getElementById('btn-cancelar-eq');
    if (btnCancel) btnCancel.style.display = "none";

    fotoBase64Temp = "";
}

function logout() {
    // 1. Resetear el estado de seguridad
    rolActual = 'usuario';
    modoAdmin = false;

    // 2. Quitar las clases CSS del body (para esconder botones de borrar/editar)
    document.body.classList.remove('role-admin', 'role-editor');

    // 3. LIMPIEZA VISUAL: Escondemos el panel de edici√≥n si estaba abierto
    const panelPlantilla = document.getElementById('panel-plantilla');
    if (panelPlantilla) panelPlantilla.style.display = "none";

    // 4. EL PASO QUE BUSCABAS: Mandar a la pantalla de inicio
    // Usamos 'sec-inicio' que es el ID que vimos en tu funci√≥n navegar
    navegar('sec-inicio'); 

    // 5. Actualizar el bot√≥n de login (para que vuelva a decir "Acceso Admin")
    aplicarRestricciones();

    // 6. Refrescar datos por si acaso
    renderTodo();

    alert("Sesi√≥n cerrada. Has vuelto al Modo Usuario.");
}

function renderTabla() {
    const contenedorTabla = document.getElementById('body-tabla');
    if (!contenedorTabla) return; 

    const t = [...db.equipos].sort((a,b) => b.pts - a.pts || (b.gf-b.gc) - (a.gf-a.gc));
    
    contenedorTabla.innerHTML = t.map((e, i) => {
        const dg = (e.gf || 0) - (e.gc || 0);
        const background = i % 2 === 0 ? '#ffffff' : '#f8fafc'; // Efecto cebra
        
        // Color para la Diferencia de Goles (Verde si es +, Rojo si es -)
        const dgColor = dg > 0 ? '#16a34a' : dg < 0 ? '#dc2626' : '#64748b';

        return `
        <tr style="background: ${background}; border-bottom: 1px solid #edf2f7; transition: 0.2s;">
            <td style="padding: 15px 10px; font-weight: 800; color: #64748b; text-align: center; width: 40px;">
                ${i + 1}
            </td>
            
            <td style="text-align: left; padding: 10px;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; background: white; border-radius: 8px; border: 1px solid #f1f5f9; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        ${e.logo ? `<img src="${e.logo}" style="width: 35px; height: 35px; object-fit: contain;">` : '<span style="font-size: 20px;">üõ°Ô∏è</span>'} 
                    </div>
                    <b style="font-size: 15px; color: #1e293b; text-transform: uppercase; letter-spacing: 0.5px;">${e.nombre}</b>
                </div>
            </td>

            <td style="text-align: center; font-weight: 600; color: #475569;">${e.pj || 0}</td>
            <td style="text-align: center; font-weight: 600; color: #475569;">${e.g || 0}</td>
            <td style="text-align: center; font-weight: 600; color: #475569;">${e.e || 0}</td>
            <td style="text-align: center; font-weight: 600; color: #475569;">${e.p || 0}</td>
            
            <td style="text-align: center; color: #94a3b8; font-size: 13px;">${e.gf || 0}</td>
            <td style="text-align: center; color: #94a3b8; font-size: 13px;">${e.gc || 0}</td>
            
            <td style="text-align: center; font-weight: 800; color: ${dgColor};">
                ${dg > 0 ? '+' : ''}${dg}
            </td>

            <td style="text-align: center; padding: 10px;">
                <div style="background: #1e293b; color: white; padding: 6px 12px; border-radius: 8px; display: inline-block; min-width: 35px; font-weight: 900; font-size: 16px;">
                    ${e.pts || 0}
                </div>
            </td>
        </tr>`;
    }).join('');
}
// USA "function" en lugar de "const" para que est√©n disponibles en todo el archivo
function cardPj(titulo, pj, valor, sub, color, icono, destino) {
    if(!pj) return "";
    const foto = pj.foto || 'https://via.placeholder.com/100?text=üë§';
    const eqObj = db.equipos.find(e => e.nombre === pj.equipo);
    const logoEq = eqObj && eqObj.logo ? eqObj.logo : 'https://via.placeholder.com/40?text=üõ°Ô∏è';
    
    return `
    <div class="card-resumen" onclick="navegar('${destino}')" style="border-top: 5px solid ${color}; cursor: pointer;">
        <small>${icono} ${titulo}</small>
        <div style="display: flex; align-items: center; gap: 12px; margin-top: 10px;">
            <div style="position: relative;">
                <img src="${foto}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid ${color};">
                <img src="${logoEq}" style="position: absolute; bottom: -5px; right: -5px; width: 22px; height: 22px; border-radius: 50%; background: white; border: 1px solid #eee; padding: 2px;">
            </div>
            <div>
                <div class="val">${pj.nombre}</div>
                <div style="font-size: 11px; font-weight: bold; color: ${color};">${pj.equipo || 'SIN EQUIPO'}</div>
                <p style="font-size: 12px; margin-top: 2px;"><b>${valor}</b> ${sub}</p>
            </div>
        </div>
    </div>`;
}

function cardEq(titulo, eq, valor, sub, color, icono, destino) {
    if(!eq) return "";
    const logo = eq.logo || 'https://via.placeholder.com/100?text=üõ°Ô∏è';
    return `
    <div class="card-resumen" onclick="navegar('${destino}')" style="border-top: 5px solid ${color}; cursor: pointer;">
        <small>${icono} ${titulo}</small>
        <div style="display: flex; align-items: center; gap: 12px; margin-top: 10px;">
            <img src="${logo}" style="width: 50px; height: 50px; object-fit: contain;">
            <div>
                <div class="val">${eq.nombre}</div>
                <p><b>${valor}</b> ${sub}</p>
            </div>
        </div>
    </div>`;
}
function renderResumenInicio() {
    const contenedor = document.getElementById('render-resumen-inicio');
    if (!contenedor || !db.equipos || db.equipos.length === 0) return;

    // C√°lculos de equipos con seguridad
    const lider = [...db.equipos].sort((a, b) => (b.pts||0) - (a.pts||0))[0];
    const mejorOf = [...db.equipos].sort((a, b) => (b.gf||0) - (a.gf||0))[0];
    const mejorDef = [...db.equipos].filter(e => (e.pj||0) > 0).sort((a, b) => (a.gc||0) - (b.gc||0))[0] || lider;

    // C√°lculos de jugadores
    const jValidos = db.jugadores.filter(j => j && j.nombre);
    
    // Generamos el HTML base de los equipos
    let htmlContent = `
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; padding: 10px;">
        ${cardEq("L√çDER GENERAL", lider, lider.pts || 0, "Puntos", "#f59e0b", "üèÜ", "sec-tabla")}
        ${cardEq("MEJOR OFENSIVA", mejorOf, mejorOf.gf || 0, "Goles", "#3b82f6", "üî•", "sec-tabla")}
        ${cardEq("MEJOR DEFENSIVA", mejorDef, mejorDef.gc || 0, "Goles Rec.", "#10b981", "üõ°Ô∏è", "sec-tabla")}`;

    // Solo si hay jugadores a√±adimos sus tarjetas
    if (jValidos.length > 0) {
        const goleador = [...jValidos].sort((a, b) => (b.goles||0) - (a.goles||0))[0];
        const mvp = [...jValidos].sort((a, b) => {
            const scA = ((a.goles||0)*10) - ((a.ama||0)*2) - ((a.roja||0)*5);
            const scB = ((b.goles||0)*10) - ((b.ama||0)*2) - ((b.roja||0)*5);
            return scB - scA;
        })[0];
        const masAma = [...jValidos].sort((a, b) => (b.ama||0) - (a.ama||0))[0];
        const masRoja = [...jValidos].sort((a, b) => (b.roja||0) - (a.roja||0))[0];

        htmlContent += `
        <div class="card-mvp-container">
            ${cardPj("MVP DE LA LIGA", mvp, ((mvp.goles||0)*10 - (mvp.ama||0)*2 - (mvp.roja||0)*5), "Pts Rendimiento", "#ffd700", "üíé", "sec-goleadores")}
        </div>
        ${cardPj("L√çDER DE GOLEO", goleador, goleador.goles||0, "Goles", "#f43f5e", "‚öΩ", "sec-goleadores")}
        ${cardPj("M√ÅS AMARILLAS", masAma, masAma.ama||0, "Tarjetas", "#eab308", "üü®", "sec-disciplina")}
        ${cardPj("M√ÅS ROJAS", masRoja, masRoja.roja||0, "Tarjetas", "#ef4444", "üü•", "sec-disciplina")}`;
    }

    htmlContent += `</div>`;
    contenedor.innerHTML = htmlContent;

    // Clase especial para el MVP
    const cardMvp = contenedor.querySelector('.card-mvp-container .card-resumen');
    if(cardMvp) cardMvp.classList.add('card-mvp');
}
function controlarFila(id, checkbox) {
    const contenedorControles = document.getElementById(`controles-${id}`);
    const fila = document.getElementById(`row-${id}`);
    
    if (checkbox.checked) {
        contenedorControles.style.opacity = "1";
        contenedorControles.style.pointerEvents = "auto";
        fila.style.opacity = "1";
        fila.style.borderColor = "var(--primary)";
    } else {
        contenedorControles.style.opacity = "0.5";
        contenedorControles.style.pointerEvents = "none";
        fila.style.opacity = "0.7";
        fila.style.borderColor = "#eee";
        // Opcional: Podr√≠as resetear los goles/tarjetas del contador visual aqu√≠
    }
    
    actualizarMarcadorVivo();
}
function imprimirTabla() {
    // 1. Capturamos los nombres actuales de la base de datos
    const nombreTorneo = db.nombreTorneoActual || "COPA CHAMPIONS 2026";
    const nombreTemp = db.nombreTemporada || "TEMPORADA 2026";

    // 2. Creamos el bloque de encabezado para el PDF
    const headerImpresion = document.createElement('div');
    headerImpresion.id = "temp-header-print";
    headerImpresion.className = "only-print"; // Usamos la clase que ya definimos en CSS
    headerImpresion.innerHTML = `
        <div style="text-align:center; margin-bottom:20px; border-bottom:3px solid #1e293b; padding-bottom:10px;">
            <h1 style="margin:0; font-size:28px; text-transform:uppercase; color:#1e293b;">${nombreTorneo}</h1>
            <h3 style="margin:5px 0; color:#3b82f6; font-size:16px;">REPORTE OFICIAL - ${nombreTemp}</h3>
          </div>
    `;

    // 3. Lo insertamos al principio de la secci√≥n de la tabla
    const secTabla = document.getElementById('sec-tabla');
    secTabla.insertBefore(headerImpresion, secTabla.firstChild);

    // 4. Aplicamos los estilos de impresi√≥n que ya ten√≠as
    const estilo = document.createElement('style');
    estilo.id = "print-style-temp";
    estilo.innerHTML = `
        @media print {
            nav, #auth-panel, .no-print, .btn-main, .nav-bar { display: none !important; }
            .seccion { display: none !important; }
            #sec-tabla { display: block !important; width: 100% !important; margin: 0 !important; padding: 0 !important; }
            #temp-header-print { display: block !important; }
            table { width: 100% !important; border-collapse: collapse; margin-top: 10px; }
            th, td { border: 1px solid #cbd5e1 !important; padding: 10px; text-align: center; font-size: 12px; }
            th { background-color: #f1f5f9 !important; font-weight: bold; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    `;
    document.head.appendChild(estilo);

    // 5. Mandamos a imprimir y limpiamos todo al terminar
    setTimeout(() => {
        window.print();
        estilo.remove();
        headerImpresion.remove(); // Quitamos el encabezado para que no se vea en la web
    }, 500);
}
function renderDisciplina() {
    const bodyDisc = document.getElementById('body-disciplina');
    const selectOrden = document.getElementById('orden-disc');
    if (!bodyDisc) return;

    // Leemos el criterio del selector (ama o roja). 
    // Si el selector no existe a√∫n, usamos 'roja' por defecto.
    const criterio = selectOrden ? selectOrden.value : 'roja';

    const d = [...db.jugadores]
        .filter(j => (j.ama || 0) > 0 || (j.roja || 0) > 0)
        .sort((a, b) => (b[criterio] || 0) - (a[criterio] || 0));

    bodyDisc.innerHTML = d.length > 0 ? d.map(j => {
        const eq = db.equipos.find(e => e.nombre === j.equipo);
        return `
        <tr>
            <td style="text-align:left">
                <div style="display:flex; align-items:center; gap:10px;">
                    <img src="${j.foto || 'https://via.placeholder.com/35?text=üë§'}" 
                         style="width:35px; height:35px; border-radius:50%; object-fit:cover; border:1px solid #ddd;">
                    <b style="font-size:14px;">${j.nombre}</b>
                </div>
            </td>
            <td style="text-align:left">
                <div style="display:flex; align-items:center; gap:8px;">
                    <img src="${eq?.logo || ''}" style="width:20px; height:20px; object-fit:contain;">
                    <span style="font-size:12px; color:#64748b;">${j.equipo}</span>
                </div>
            </td>
            <td>${j.ama > 0 ? `<div class="card-ui ama">${j.ama}</div>` : '-'}</td>
            <td>${j.roja > 0 ? `<div class="card-ui roja">${j.roja}</div>` : '-'}</td>
        </tr>`;
    }).join('') : `<tr><td colspan="4" style="padding:30px; color:#94a3b8;">No hay sanciones.</td></tr>`;
}
function guardarConfiguracionGeneral() {
    const nuevoTorneo = document.getElementById('cfg-nombre-torneo').value.trim();
    const nuevaTemp = document.getElementById('cfg-nombre-temporada').value.trim();

    if (nuevoTorneo === "" || nuevaTemp === "") return alert("Por favor, llena los campos.");

    // 1. Actualizamos la variable de sesi√≥n
    nombreTorneoActual = nuevoTorneo;

    // 2. Actualizamos el OBJETO DB (Esto es lo que se guarda en el disco)
    db.nombreTorneoActual = nuevoTorneo; 
    db.nombreTemporada = nuevaTemp;

    // 3. Guardamos permanentemente
    persist();
    
    // 4. Actualizamos el banner visualmente
    actualizarBanner();
    
    alert("‚úÖ Cambios guardados. Ahora s√≠ son permanentes.");
}
</script>
<link rel="manifest" href="./manifest.json">

    <script>
      if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
        navigator.serviceWorker.register('./sw.js')
          .then(() => console.log("‚úÖ PWA lista para instalar"))
          .catch(err => console.log("‚ùå Fallo registro SW", err));
      } else if (window.location.protocol === 'file:') {
        console.log("‚ö†Ô∏è PWA: Usa un servidor para instalar.");
      }
    </script>

    <script>
      // Verificamos que Firebase est√© listo antes de escuchar
      if (typeof database !== 'undefined') {
          database.ref('liga_datos').on('value', (snapshot) => {
              const data = snapshot.val();
              if (data) {
                  db = data; 
                  if (typeof renderTabla === 'function') renderTabla();
                  if (typeof renderGoleadores === 'function') renderGoleadores();
                  if (typeof actualizarBanner === 'function') actualizarBanner();
                  console.log("üîÑ ¬°Vista actualizada con datos de la nube!");
              }
          });
      }
    </script>

</body>
</html>